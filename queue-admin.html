<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Queue Admin Panel - BAMACO</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
      <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="assets/tailwind-config.js"></script>
    <script>tailwind.config = window.BAMACO_TAILWIND_CONFIG;</script>
  
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body class="bg-bg-primary text-text-primary font-sans antialiased">
  <!-- Navigation -->
  <!-- Navbar will be dynamically generated by navbar.js -->

  <!-- Login Form -->
  <div class="max-w-md mx-auto px-4 py-24" id="loginSection">
    <div class="bg-bg-card border border-border-primary rounded-xl p-8">
      <h1 class="text-3xl font-black mb-2 text-center">Admin Login</h1>
      <p class="text-text-muted text-center mb-6">Enter password to access queue management</p>
      <form id="loginForm">
        <div class="mb-6">
          <input 
            type="password" 
            id="adminPassword" 
            placeholder="Admin Password"
            class="w-full px-4 py-3 bg-bg-secondary border border-border-primary rounded-lg text-text-primary text-base focus:outline-none focus:border-text-secondary transition-all duration-300"
            required
          >
        </div>
        <button type="submit" class="w-full px-6 py-3 bg-green-200 text-green-800 font-bold rounded-lg transition-all duration-300 hover-btn-primary">Login</button>
      </form>
      <p id="loginError" class="text-red-500 text-center mt-4 hidden">
        Incorrect password
      </p>
    </div>
  </div>

  <!-- Admin Panel -->
  <div class="hidden" id="adminPanel">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-8 sm:py-12">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
        <h1 class="text-3xl sm:text-4xl font-black">Queue Management</h1>
        <button onclick="logout()" class="px-6 py-2 bg-bg-secondary border border-border-primary rounded-lg font-semibold hover-btn-secondary">Logout</button>
      </div>

      <!-- Member Queue Requests (New Notifications Section) -->
      <div class="bg-bg-card border border-border-primary rounded-xl p-6 sm:p-8 mb-6" id="queueRequestsSection">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl sm:text-2xl font-bold flex items-center gap-2">
            ðŸ”” Queue Requests
            <span id="requestsBadge" class="bg-accent-pink text-white text-sm px-2 py-0.5 rounded-full hidden">0</span>
          </h2>
          <button onclick="refreshQueueRequests()" class="px-3 py-1 text-sm bg-bg-secondary border border-border-primary rounded hover-btn-secondary">Refresh</button>
        </div>
        <div id="queueRequestsDisplay" class="space-y-3">
          <p class="text-text-muted text-center py-4">No pending queue requests</p>
        </div>
      </div>

      <!-- Credits Management Card -->
      <div class="bg-bg-card border border-border-primary rounded-xl p-6 sm:p-8 mb-6">
        <h2 class="text-xl sm:text-2xl font-bold mb-6">Credits Management</h2>
        <div class="flex flex-col sm:flex-row gap-3 mb-6">
          <input 
            type="text" 
            id="creditPlayerName" 
            placeholder="Player name"
            class="flex-1 px-4 py-3 bg-bg-secondary border border-border-primary rounded-lg text-text-primary focus:outline-none focus:border-text-secondary transition-all duration-300"
          >
          <input 
            type="number" 
            id="creditAmount" 
            placeholder="Credits"
            min="0"
            value="1"
            class="w-full sm:w-24 px-4 py-3 bg-bg-secondary border border-border-primary rounded-lg text-text-primary focus:outline-none focus:border-text-secondary transition-all duration-300"
          >
          <button onclick="addCredits()" class="px-6 py-3 bg-yellow-200 text-yellow-800 font-semibold rounded-lg hover-btn-primary transition-all duration-300">Add Credits</button>
          <button onclick="removeCredits()" class="px-6 py-3 bg-bg-secondary border border-border-primary font-semibold rounded-lg hover-btn-secondary">Remove Credits</button>
        </div>
        
        <h3 class="text-lg font-bold mb-3">Current Credits</h3>
        <div id="creditsDisplay" class="grid gap-2 max-h-48 overflow-y-auto">
          <p class="text-text-muted text-center py-6">
            No credits assigned
          </p>
        </div>
      </div>

      <!-- Currently Playing -->
      <div class="bg-bg-card border-2 border-border-primary rounded-xl p-6 sm:p-8 mb-6 text-center">
        <h2 class="text-xl sm:text-2xl font-bold mb-4">Currently Playing</h2>
        <div id="currentlyPlaying" class="text-xl sm:text-2xl font-bold">
          <span>No one playing</span>
        </div>
        <button onclick="clearCurrentPlayers()" class="w-full mt-4 px-6 py-3 bg-bg-secondary border border-border-primary font-semibold rounded-lg hover-btn-secondary">
          Finish Current Game
        </button>
      </div>

      <!-- Add Player -->
      <div class="flex flex-col sm:flex-row gap-3 mb-6">
        <input 
          type="text" 
          id="newPlayerName" 
          placeholder="Enter player name"
          class="flex-1 px-4 py-3 bg-bg-secondary border border-border-primary rounded-lg text-text-primary focus:outline-none focus:border-text-secondary transition-all duration-300"
        >
        <button onclick="addPlayer()" class="px-6 py-3 bg-green-200 text-green-800 font-semibold rounded-lg hover-btn-primary transition-all duration-300">Add to Queue</button>
      </div>

      <!-- Swap Controls -->
      <div class="flex flex-col sm:flex-row items-center gap-3 mb-6">
        <span class="text-text-secondary">Swap positions:</span>
        <input type="number" id="swapPos1" min="1" placeholder="Pos 1" class="w-full sm:w-20 px-3 py-2 bg-bg-secondary border border-border-primary rounded-lg text-text-primary focus:outline-none focus:border-text-secondary">
        <span class="text-text-muted">â†”</span>
        <input type="number" id="swapPos2" min="1" placeholder="Pos 2" class="w-full sm:w-20 px-3 py-2 bg-bg-secondary border border-border-primary rounded-lg text-text-primary focus:outline-none focus:border-text-secondary">
        <button onclick="swapPlayers()" class="w-full sm:w-auto px-6 py-2 bg-bg-secondary border border-border-primary font-semibold rounded-lg hover-btn-secondary">Swap</button>
      </div>

      <!-- Main Queue Actions -->
      <div class="flex flex-col sm:flex-row gap-3 mb-6">
        <button onclick="nextPairPlaying()" class="px-6 py-3 bg-green-200 text-green-800 font-semibold rounded-lg hover-btn-primary transition-all duration-300">
          â–¶ Next Pair Playing
        </button>
        <button onclick="nextSoloPlaying()" class="px-6 py-3 bg-yellow-200 text-yellow-800 font-semibold rounded-lg hover-btn-primary transition-all duration-300">
          â–¶ Next Solo Playing
        </button>
        <button onclick="deleteTopPair()" class="px-6 py-3 bg-bg-secondary border border-border-primary font-semibold rounded-lg hover-btn-secondary">
          Delete Top Pair
        </button>
      </div>

      <!-- Queue List -->
      <div class="bg-bg-card border border-border-primary rounded-xl p-6 sm:p-8">
        <h2 class="text-xl sm:text-2xl font-bold mb-6">Queue (<span id="queueCount">0</span> players)</h2>
        <div id="queueDisplay">
          <p class="text-text-muted text-center py-8">
            Queue is empty
          </p>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/page-transitions.js"></script>
  <script src="assets/navbar.js"></script>
  
  <script>
    // Move the main login logic outside of the module to prevent Firebase import blocking the login
    const ADMIN_PASSWORD = 'Nachi';

    // Check if already logged in
    if (localStorage.getItem('bamaco_admin_auth') === 'true') {
      showAdminPanel();
    }

    // Login form
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('loginForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const password = document.getElementById('adminPassword').value;
        
        console.log('Password entered:', password); // Debug log
        console.log('Expected password:', ADMIN_PASSWORD); // Debug log
        
        if (password === ADMIN_PASSWORD) {
          localStorage.setItem('bamaco_admin_auth', 'true');
          console.log('Login successful!'); // Debug log
          showAdminPanel();
        } else {
          console.log('Login failed!'); // Debug log
          document.getElementById('loginError').classList.remove('hidden');
        }
      });
    });

    function showAdminPanel() {
      console.log('Showing admin panel...'); // Debug log
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('adminPanel').classList.remove('hidden');
      document.getElementById('adminPanel').style.display = 'block';
      // Initialize Firebase-dependent features after login
      if (typeof initializeQueue === 'function') {
        initializeQueue();
      }
      // Load queue requests
      loadQueueRequests();
    }

    // Queue Requests Management
    window.loadQueueRequests = function() {
      const requests = JSON.parse(localStorage.getItem('bamaco_queue_requests') || '[]');
      const pendingRequests = requests.filter(r => r.status === 'pending');
      
      const container = document.getElementById('queueRequestsDisplay');
      const badge = document.getElementById('requestsBadge');
      
      if (pendingRequests.length > 0) {
        badge.textContent = pendingRequests.length;
        badge.classList.remove('hidden');
        
        container.innerHTML = pendingRequests.map(req => `
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 p-4 bg-bg-secondary border border-border-primary rounded-lg">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-accent-pink rounded-full flex items-center justify-center text-white font-bold">
                ${req.ign?.charAt(0).toUpperCase() || '?'}
              </div>
              <div>
                <p class="font-semibold">${req.ign || 'Unknown'}</p>
                <p class="text-xs text-text-muted">FC: ${formatFriendCode(req.friendCode)} â€¢ ${timeAgo(req.requestedAt)}</p>
              </div>
            </div>
            <div class="flex gap-2 w-full sm:w-auto">
              <button onclick="approveQueueRequest('${req.id}', '${req.ign}')" class="flex-1 sm:flex-none px-4 py-2 bg-green-200 text-green-800 font-semibold rounded-lg hover-btn-primary text-sm">
                âœ“ Approve
              </button>
              <button onclick="denyQueueRequest('${req.id}')" class="flex-1 sm:flex-none px-4 py-2 bg-red-200 text-red-800 font-semibold rounded-lg hover:bg-red-300 text-sm">
                âœ— Deny
              </button>
            </div>
          </div>
        `).join('');
      } else {
        badge.classList.add('hidden');
        container.innerHTML = '<p class="text-text-muted text-center py-4">No pending queue requests</p>';
      }
    };

    window.refreshQueueRequests = function() {
      loadQueueRequests();
    };

    window.approveQueueRequest = function(requestId, playerName) {
      // Update request status
      const requests = JSON.parse(localStorage.getItem('bamaco_queue_requests') || '[]');
      const index = requests.findIndex(r => r.id === requestId);
      if (index !== -1) {
        requests[index].status = 'approved';
        localStorage.setItem('bamaco_queue_requests', JSON.stringify(requests));
      }
      
      // Remove from admin notifications
      const notifications = JSON.parse(localStorage.getItem('bamaco_admin_notifications') || '[]');
      const filtered = notifications.filter(n => n.requestId !== requestId);
      localStorage.setItem('bamaco_admin_notifications', JSON.stringify(filtered));
      
      // Add player to actual queue
      document.getElementById('newPlayerName').value = playerName;
      if (typeof window.addPlayer === 'function') {
        window.addPlayer();
      }
      
      loadQueueRequests();
      alert(`âœ… ${playerName} has been added to the queue!`);
    };

    window.denyQueueRequest = function(requestId) {
      // Update request status
      const requests = JSON.parse(localStorage.getItem('bamaco_queue_requests') || '[]');
      const index = requests.findIndex(r => r.id === requestId);
      if (index !== -1) {
        requests[index].status = 'denied';
        localStorage.setItem('bamaco_queue_requests', JSON.stringify(requests));
      }
      
      // Remove from admin notifications
      const notifications = JSON.parse(localStorage.getItem('bamaco_admin_notifications') || '[]');
      const filtered = notifications.filter(n => n.requestId !== requestId);
      localStorage.setItem('bamaco_admin_notifications', JSON.stringify(filtered));
      
      loadQueueRequests();
    };

    function formatFriendCode(code) {
      if (!code) return '---';
      return code.match(/.{1,3}/g)?.join('-') || code;
    }

    function timeAgo(dateString) {
      if (!dateString) return 'Unknown';
      const date = new Date(dateString);
      const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
      
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
      return `${Math.floor(seconds / 86400)}d ago`;
    }

    window.logout = function() {
      localStorage.removeItem('bamaco_admin_auth');
      location.reload();
    };
  </script>

  <script type="module">
    // Firebase-dependent code in separate module
    import { database, queueRef, currentlyPlayingRef, gameHistoryRef, playerCreditsRef, ref, onValue, set, push, get, update, remove } from './config/firebase-config.js';

    // Test Firebase connection
    console.log('Firebase modules imported successfully');
    console.log('Database:', database);
    console.log('Queue ref:', queueRef);
    
    // Test if we can read from Firebase
    try {
      const testRef = ref(database, 'test');
      onValue(testRef, (snapshot) => {
        console.log('Firebase connection test successful!');
        console.log('Test data:', snapshot.val());
      }, (error) => {
        console.error('Firebase connection error:', error);
      });
    } catch (error) {
      console.error('Firebase initialization error:', error);
    }
    
    let queue = [];
    let currentlyPlaying = [];
    let playerCredits = {};

    // Check if already logged in
    if (localStorage.getItem('bamaco_admin_auth') === 'true') {
      showAdminPanel();
    }

    // Login form
    document.getElementById('loginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const password = document.getElementById('adminPassword').value;
      
      if (password === ADMIN_PASSWORD) {
        localStorage.setItem('bamaco_admin_auth', 'true');
        showAdminPanel();
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    });

    function showAdminPanel() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'block';
      initializeQueue();
    }

    window.logout = function() {
      localStorage.removeItem('bamaco_admin_auth');
      location.reload();
    };

    function initializeQueue() {
      // Listen to queue changes
      onValue(queueRef, (snapshot) => {
        queue = [];
        snapshot.forEach((child) => {
          queue.push({ key: child.key, ...child.val() });
        });
        renderQueue();
      });

      // Listen to currently playing changes
      onValue(currentlyPlayingRef, (snapshot) => {
        currentlyPlaying = [];
        snapshot.forEach((child) => {
          currentlyPlaying.push(child.val());
        });
        renderCurrentlyPlaying();
      });

      // Listen to player credits changes
      onValue(playerCreditsRef, (snapshot) => {
        playerCredits = {};
        snapshot.forEach((child) => {
          playerCredits[child.key] = child.val();
        });
        renderCredits();
      });
    }

    function renderQueue() {
      const display = document.getElementById('queueDisplay');
      const count = document.getElementById('queueCount');
      
      count.textContent = queue.length;

      if (queue.length === 0) {
        display.innerHTML = '<p class="text-text-muted text-center py-8">Queue is empty</p>';
        return;
      }

      // Create 2-column grid layout for all screen sizes
      display.innerHTML = `
        <div class="grid grid-cols-2 gap-2 sm:gap-4">
          ${queue.map((player, index) => {
            return `
            <div class="flex flex-col justify-between items-start p-3 sm:p-4 border border-border-primary hover:bg-bg-tertiary transition-all duration-200 rounded gap-2">
              <div class="flex items-center gap-2 w-full">
                <span class="w-8 h-8 sm:w-9 sm:h-9 bg-bg-tertiary border border-border-primary rounded-full flex items-center justify-center font-bold text-xs sm:text-sm flex-shrink-0">${index + 1}</span>
                <strong class="text-xs sm:text-sm truncate flex-1">${player.name}</strong>
              </div>
              <div class="w-full">
                ${player.paid ? '<span class="px-2 py-1 bg-bg-tertiary text-green-500 border border-green-500 rounded text-xs block text-center mb-1">âœ“ PAID</span>' : '<span class="px-2 py-1 bg-bg-tertiary text-red-500 border border-red-500 rounded text-xs block text-center mb-1">âœ— UNPAID</span>'}
              </div>
              <div class="flex gap-1 w-full">
                <button onclick="togglePaid('${player.key}', ${player.paid})" class="flex-1 px-2 py-1 bg-bg-secondary border border-border-primary rounded text-xs font-semibold hover-btn-secondary">
                  ${player.paid ? 'Unpaid' : 'Paid'}
                </button>
                <button onclick="deletePlayer('${player.key}')" class="flex-1 px-2 py-1 bg-bg-secondary border border-border-primary rounded text-xs font-semibold hover-btn-secondary">Delete</button>
              </div>
            </div>
          `;
          }).join('')}
        </div>
      `;
    }

    function renderCurrentlyPlaying() {
      const display = document.getElementById('currentlyPlaying');
      
      if (currentlyPlaying.length === 0) {
        display.innerHTML = '<span>No one playing</span>';
      } else {
        display.innerHTML = currentlyPlaying.map(p => `<span>${p.name}</span>`).join(' <span>and</span> ');
      }
    }

    function renderCredits() {
      const display = document.getElementById('creditsDisplay');
      
      if (Object.keys(playerCredits).length === 0) {
        display.innerHTML = '<p class="text-text-muted text-center py-6">No credits assigned</p>';
        return;
      }

      display.innerHTML = Object.entries(playerCredits)
        .filter(([name, credits]) => credits > 0)
        .sort(([,a], [,b]) => b - a)
        .map(([name, credits]) => `
          <div class="flex justify-between items-center p-2 bg-bg-secondary rounded">
            <span><strong>${name}</strong></span>
            <span class="text-text-secondary">${credits} ${credits === 1 ? 'Credit' : 'Credits'}</span>
          </div>
        `).join('');
    }

    // Add player with credit logic
    window.addPlayer = async function() {
      const input = document.getElementById('newPlayerName');
      const name = input.value.trim();
      
      if (!name) return;

      // Check if player already in queue
      const existingPlayer = queue.find(p => p.name.toLowerCase() === name.toLowerCase());
      
      if (existingPlayer) {
        // Player already in queue - add 1 credit instead
        const currentCredits = playerCredits[name] || 0;
        await set(ref(database, `playerCredits/${name}`), currentCredits + 1);
        
        // Show feedback
        input.value = '';
        input.placeholder = `+1 Credit added to ${name}`;
        setTimeout(() => {
          input.placeholder = "Enter player name";
        }, 2000);
        return;
      }

      // Add player to queue and give 1 credit
      await push(queueRef, {
        name: name,
        paid: false,
        timestamp: Date.now()
      });

      // Add 1 credit for being in queue
      const currentCredits = playerCredits[name] || 0;
      await set(ref(database, `playerCredits/${name}`), currentCredits + 1);

      input.value = '';
    };

    // Credit management functions
    window.addCredits = async function() {
      const nameInput = document.getElementById('creditPlayerName');
      const amountInput = document.getElementById('creditAmount');
      const name = nameInput.value.trim();
      const amount = parseInt(amountInput.value) || 1;
      
      if (!name) return;

      const currentCredits = playerCredits[name] || 0;
      await set(ref(database, `playerCredits/${name}`), currentCredits + amount);
      
      nameInput.value = '';
      amountInput.value = '1';
    };

    window.removeCredits = async function() {
      const nameInput = document.getElementById('creditPlayerName');
      const amountInput = document.getElementById('creditAmount');
      const name = nameInput.value.trim();
      const amount = parseInt(amountInput.value) || 1;
      
      if (!name) return;

      const currentCredits = playerCredits[name] || 0;
      const newCredits = Math.max(0, currentCredits - amount);
      
      if (newCredits === 0) {
        await remove(ref(database, `playerCredits/${name}`));
      } else {
        await set(ref(database, `playerCredits/${name}`), newCredits);
      }
      
      nameInput.value = '';
      amountInput.value = '1';
    };

    // Allow Enter key to add player
    document.getElementById('newPlayerName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        window.addPlayer();
      }
    });

    // Toggle paid status
    window.togglePaid = async function(key, currentStatus) {
      const playerRef = ref(database, `queue/${key}`);
      await update(playerRef, { paid: !currentStatus });
    };

    // Delete player
    window.deletePlayer = async function(key) {
      if (confirm('Delete this player from queue?')) {
        const playerRef = ref(database, `queue/${key}`);
        await remove(playerRef);
      }
    };

    // Delete top pair
    window.deleteTopPair = async function() {
      if (queue.length === 0) return;
      
      if (confirm('Delete top 2 players from queue?')) {
        const toDelete = queue.slice(0, 2);
        for (const player of toDelete) {
          const playerRef = ref(database, `queue/${player.key}`);
          await remove(playerRef);
        }
      }
    };

    // Swap players
    window.swapPlayers = async function() {
      const pos1 = parseInt(document.getElementById('swapPos1').value) - 1;
      const pos2 = parseInt(document.getElementById('swapPos2').value) - 1;

      if (pos1 < 0 || pos2 < 0 || pos1 >= queue.length || pos2 >= queue.length) {
        alert('Invalid positions');
        return;
      }

      // Get current queue
      const snapshot = await get(queueRef);
      const queueArray = [];
      snapshot.forEach((child) => {
        queueArray.push({ key: child.key, ...child.val() });
      });

      // Swap
      [queueArray[pos1], queueArray[pos2]] = [queueArray[pos2], queueArray[pos1]];

      // Clear and rewrite
      await set(queueRef, null);
      for (const player of queueArray) {
        const { key, ...data } = player;
        await push(queueRef, data);
      }

      // Clear inputs
      document.getElementById('swapPos1').value = '';
      document.getElementById('swapPos2').value = '';
    };

    // Next pair playing with credit logic
    window.nextPairPlaying = async function() {
      if (queue.length < 2) {
        alert('Not enough players in queue');
        return;
      }

      const pair = queue.slice(0, 2);
      
      // If there are currently playing players, finish their game first
      if (currentlyPlaying.length > 0) {
        await finishCurrentGame();
      }

      // Set new pair as currently playing
      await set(currentlyPlayingRef, pair.map(p => ({ name: p.name })));

      // Process credits for each player
      for (const player of pair) {
        // Reduce 1 credit (moving from queue to playing)
        const currentCredits = playerCredits[player.name] || 0;
        const newCredits = Math.max(0, currentCredits - 1);
        
        if (newCredits === 0) {
          await remove(ref(database, `playerCredits/${player.name}`));
        } else {
          await set(ref(database, `playerCredits/${player.name}`), newCredits);
        }

        // Remove from queue
        const playerRef = ref(database, `queue/${player.key}`);
        await remove(playerRef);
      }
    };

    // Next solo playing with credit logic  
    window.nextSoloPlaying = async function() {
      if (queue.length < 1) {
        alert('No players in queue');
        return;
      }

      const soloPlayer = queue[0];
      
      // If there are currently playing players, finish their game first
      if (currentlyPlaying.length > 0) {
        await finishCurrentGame();
      }

      // Set solo player as currently playing
      await set(currentlyPlayingRef, [{ name: soloPlayer.name }]);

      // Process credits for the player
      const currentCredits = playerCredits[soloPlayer.name] || 0;
      const newCredits = Math.max(0, currentCredits - 1);
      
      if (newCredits === 0) {
        await remove(ref(database, `playerCredits/${soloPlayer.name}`));
      } else {
        await set(ref(database, `playerCredits/${soloPlayer.name}`), newCredits);
      }

      // Remove from queue
      const playerRef = ref(database, `queue/${soloPlayer.key}`);
      await remove(playerRef);
    };

    // Function to finish current game and handle credit logic
    async function finishCurrentGame() {
      if (currentlyPlaying.length === 0) return;

      // Add finished players to game history
      await push(gameHistoryRef, {
        players: currentlyPlaying.map(p => p.name),
        timestamp: Date.now()
      });

      // Auto-requeue players with remaining credits
      for (const player of currentlyPlaying) {
        const remainingCredits = playerCredits[player.name] || 0;
        
        if (remainingCredits > 0) {
          // Add back to end of queue
          await push(queueRef, {
            name: player.name,
            paid: true, // They have credits so mark as paid
            timestamp: Date.now()
          });
        }
      }
    }

    // Clear currently playing with credit logic
    window.clearCurrentPlayers = async function() {
      if (confirm('Finish current game and clear players?')) {
        await finishCurrentGame();
        await set(currentlyPlayingRef, null);
      }
    };
  </script>
</body>
</html>
