<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Queue Admin Panel - BAMACO</title>
  <link rel="stylesheet" href="styles.css">  <link rel="stylesheet" href="enhanced-styles.css">  <style>
    .admin-login {
      max-width: 400px;
      margin: 100px auto;
      padding: 0 var(--spacing-md);
      text-align: center;
    }
    
    .admin-panel {
      display: none;
    }
    
    .queue-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: clamp(1rem, 2vw, 1.5rem);
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
      gap: var(--spacing-sm);
    }
    
    .section-header h1 {
      font-size: clamp(1.5rem, 4vw, 2.5rem);
    }
    
    .queue-list {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: clamp(1rem, 2vw, 1.5rem);
      margin-bottom: var(--spacing-lg);
    }
    
    .queue-list h2 {
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      font-size: clamp(1.25rem, 3vw, 1.75rem);
    }
    
    .queue-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-sm);
      border-bottom: 1px solid var(--border-color);
      transition: background 0.2s;
      border-radius: var(--radius-sm);
      gap: var(--spacing-sm);
    }
    
    .queue-item:hover {
      background: var(--bg-tertiary);
    }
    
    .queue-item:last-child {
      border-bottom: none;
    }
    
    .player-info {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      flex: 1;
      min-width: 0;
    }
    
    .player-info strong {
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .position-badge {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    .paid-badge {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      border: 1px solid var(--border-color);
      white-space: nowrap;
    }
    
    .queue-actions {
      display: flex;
      gap: var(--spacing-xs);
      flex-shrink: 0;
      flex-wrap: wrap;
    }
    
    .btn-small {
      padding: 8px 14px;
      font-size: 14px;
      white-space: nowrap;
    }
    
    .currently-playing {
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      color: var(--text-primary);
      padding: clamp(1rem, 3vw, 1.5rem);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-lg);
      text-align: center;
    }
    
    .currently-playing h2 {
      font-size: clamp(1.25rem, 3vw, 1.75rem);
      margin-bottom: var(--spacing-sm);
    }
    
    .playing-pair {
      display: flex;
      justify-content: center;
      gap: var(--spacing-md);
      margin-top: var(--spacing-sm);
      font-size: clamp(1.25rem, 4vw, 1.75rem);
      font-weight: bold;
      flex-wrap: wrap;
      color: var(--text-primary);
    }
    
    .add-player-form {
      display: flex;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-lg);
      flex-wrap: wrap;
    }
    
    .add-player-form input {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 12px;
    }

    .add-player-form input[type="text"] {
      flex: 2;
      min-width: 200px;
    }

    .add-player-form input[type="number"] {
      width: 100px;
    }
    
    .add-player-form input::placeholder {
      color: var(--text-muted);
    }
    
    .swap-controls {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
    }
    
    .swap-controls input {
      width: 80px;
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 8px;
    }
    
    .swap-controls span {
      color: var(--text-secondary);
    }

    @media (max-width: 768px) {
      .section-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .section-header button {
        width: 100%;
      }
      
      .queue-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .queue-actions {
        width: 100%;
        margin-top: var(--spacing-xs);
      }
      
      .queue-actions button {
        flex: 1;
      }
      
      .add-player-form {
        flex-direction: column;
      }
      
      .add-player-form input,
      .add-player-form button {
        width: 100%;
      }
      
      .swap-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .swap-controls input,
      .swap-controls button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <!-- Navbar will be dynamically generated by navbar.js -->

  <!-- Login Form -->
  <div class="admin-login" id="loginSection">
    <div class="card">
      <h1>Admin Login</h1>
      <p class="text-muted">Enter password to access queue management</p>
      <form id="loginForm">
        <div style="margin: var(--spacing-md) 0;">
          <input 
            type="password" 
            id="adminPassword" 
            placeholder="Admin Password"
            style="width: 100%; padding: 12px; font-size: 16px;"
            required
          >
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
      </form>
      <p id="loginError" style="color: #dc3545; margin-top: var(--spacing-sm); display: none;">
        Incorrect password
      </p>
    </div>
  </div>

  <!-- Admin Panel -->
  <div class="admin-panel" id="adminPanel">
    <div class="queue-container">
      <div class="section-header">
        <h1>Queue Management</h1>
        <button onclick="logout()" class="btn btn-secondary">Logout</button>
      </div>

      <!-- Credits Management Card -->
      <div class="queue-list">
        <h2>Credits Management</h2>
        <div class="add-player-form" style="margin-bottom: var(--spacing-md);">
          <input 
            type="text" 
            id="creditPlayerName" 
            placeholder="Player name"
            style="padding: 12px; font-size: 16px; flex: 2;"
          >
          <input 
            type="number" 
            id="creditAmount" 
            placeholder="Credits"
            min="0"
            value="1"
            style="padding: 12px; font-size: 16px; width: 100px;"
          >
          <button onclick="addCredits()" class="btn btn-primary">Add Credits</button>
          <button onclick="removeCredits()" class="btn btn-secondary">Remove Credits</button>
        </div>
        
        <h3 style="margin-bottom: var(--spacing-sm);">Current Credits</h3>
        <div id="creditsDisplay" style="display: grid; gap: var(--spacing-xs); max-height: 200px; overflow-y: auto;">
          <p class="text-muted" style="text-align: center; padding: var(--spacing-md);">
            No credits assigned
          </p>
        </div>
      </div>

      <!-- Currently Playing -->
      <div class="currently-playing">
        <h2>Currently Playing</h2>
        <div class="playing-pair" id="currentlyPlaying">
          <span>No one playing</span>
        </div>
        <button onclick="clearCurrentPlayers()" class="btn btn-secondary" style="margin-top: var(--spacing-sm);">
          Clear Current Players
        </button>
      </div>

      <!-- Add Player -->
      <div class="add-player-form">
        <input 
          type="text" 
          id="newPlayerName" 
          placeholder="Enter player name"
          style="padding: 12px; font-size: 16px;"
        >
        <button onclick="addPlayer()" class="btn btn-primary">Add to Queue</button>
      </div>

      <!-- Swap Controls -->
      <div class="swap-controls">
        <span>Swap positions:</span>
        <input type="number" id="swapPos1" min="1" placeholder="Pos 1">
        <span>â†”</span>
        <input type="number" id="swapPos2" min="1" placeholder="Pos 2">
        <button onclick="swapPlayers()" class="btn btn-secondary btn-small">Swap</button>
      </div>

      <!-- Main Queue Actions -->
      <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-md); flex-wrap: wrap;">
        <button onclick="nextPairPlaying()" class="btn btn-primary">
          â–¶ Next Pair Playing
        </button>
        <button onclick="nextSoloPlaying()" class="btn btn-primary">
          â–¶ Next Solo Playing
        </button>
        <button onclick="deleteTopPair()" class="btn btn-secondary">
          Delete Top Pair
        </button>
      </div>

      <!-- Queue List -->
      <div class="queue-list">
        <h2>Queue (<span id="queueCount">0</span> players)</h2>
        <div id="queueDisplay">
          <p class="text-muted" style="text-align: center; padding: var(--spacing-lg);">
            Queue is empty
          </p>
        </div>
      </div>
    </div>
  </div>

  <script src="navbar.js"></script>
  <script type="module">
    import { database, queueRef, currentlyPlayingRef, gameHistoryRef, playerCreditsRef, ref, onValue, set, push, get, update, remove } from './firebase-config.js';

    const ADMIN_PASSWORD = 'Nachi';
    let queue = [];
    let currentlyPlaying = [];
    let playerCredits = {};

    // Check if already logged in
    if (localStorage.getItem('bamaco_admin_auth') === 'true') {
      showAdminPanel();
    }

    // Login form
    document.getElementById('loginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const password = document.getElementById('adminPassword').value;
      
      if (password === ADMIN_PASSWORD) {
        localStorage.setItem('bamaco_admin_auth', 'true');
        showAdminPanel();
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    });

    function showAdminPanel() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'block';
      initializeQueue();
    }

    window.logout = function() {
      localStorage.removeItem('bamaco_admin_auth');
      location.reload();
    };

    function initializeQueue() {
      // Listen to queue changes
      onValue(queueRef, (snapshot) => {
        queue = [];
        snapshot.forEach((child) => {
          queue.push({ key: child.key, ...child.val() });
        });
        renderQueue();
      });

      // Listen to currently playing changes
      onValue(currentlyPlayingRef, (snapshot) => {
        currentlyPlaying = [];
        snapshot.forEach((child) => {
          currentlyPlaying.push(child.val());
        });
        renderCurrentlyPlaying();
      });

      // Listen to player credits changes
      onValue(playerCreditsRef, (snapshot) => {
        playerCredits = {};
        snapshot.forEach((child) => {
          playerCredits[child.key] = child.val();
        });
        renderCredits();
      });
    }

    function renderQueue() {
      const display = document.getElementById('queueDisplay');
      const count = document.getElementById('queueCount');
      
      count.textContent = queue.length;

      if (queue.length === 0) {
        display.innerHTML = '<p class="text-muted" style="text-align: center; padding: var(--spacing-lg);">Queue is empty</p>';
        return;
      }

      display.innerHTML = queue.map((player, index) => {
        const credits = playerCredits[player.name] || 0;
        return `
        <div class="queue-item">
          <div class="player-info">
            <span class="position-badge">${index + 1}</span>
            <strong>${player.name}</strong>
            <span class="paid-badge" style="background: var(--bg-tertiary); color: var(--text-secondary); border-color: var(--border-color);">ðŸ’³ ${credits} ${credits === 1 ? 'Credit' : 'Credits'}</span>
            ${player.paid ? '<span class="paid-badge" style="background: var(--bg-tertiary); color: #4caf50; border-color: #4caf50;">âœ“ PAID</span>' : '<span class="paid-badge" style="background: var(--bg-tertiary); color: #f44336; border-color: #f44336;">âœ— UNPAID</span>'}
          </div>
          <div class="queue-actions">
            <button onclick="togglePaid('${player.key}', ${player.paid})" class="btn btn-secondary btn-small">
              ${player.paid ? 'Mark Unpaid' : 'Mark Paid'}
            </button>
            <button onclick="deletePlayer('${player.key}')" class="btn btn-secondary btn-small">Delete</button>
          </div>
        </div>
      `;}).join('');
    }

    function renderCurrentlyPlaying() {
      const display = document.getElementById('currentlyPlaying');
      
      if (currentlyPlaying.length === 0) {
        display.innerHTML = '<span>No one playing</span>';
      } else {
        display.innerHTML = currentlyPlaying.map(p => `<span>${p.name}</span>`).join(' <span>vs</span> ');
      }
    }

    function renderCredits() {
      const display = document.getElementById('creditsDisplay');
      
      if (Object.keys(playerCredits).length === 0) {
        display.innerHTML = '<p class="text-muted" style="text-align: center; padding: var(--spacing-md);">No credits assigned</p>';
        return;
      }

      display.innerHTML = Object.entries(playerCredits)
        .filter(([name, credits]) => credits > 0)
        .sort(([,a], [,b]) => b - a)
        .map(([name, credits]) => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-xs); background: var(--bg-secondary); border-radius: var(--radius-sm); margin-bottom: 4px;">
            <span><strong>${name}</strong></span>
            <span style="color: var(--text-secondary);">${credits} ${credits === 1 ? 'Credit' : 'Credits'}</span>
          </div>
        `).join('');
    }

    // Add player with credit logic
    window.addPlayer = async function() {
      const input = document.getElementById('newPlayerName');
      const name = input.value.trim();
      
      if (!name) return;

      // Check if player already in queue
      const existingPlayer = queue.find(p => p.name.toLowerCase() === name.toLowerCase());
      
      if (existingPlayer) {
        // Player already in queue - add 1 credit instead
        const currentCredits = playerCredits[name] || 0;
        await set(ref(database, `playerCredits/${name}`), currentCredits + 1);
        
        // Show feedback
        input.value = '';
        input.placeholder = `+1 Credit added to ${name}`;
        setTimeout(() => {
          input.placeholder = "Enter player name";
        }, 2000);
        return;
      }

      // Add player to queue and give 1 credit
      await push(queueRef, {
        name: name,
        paid: false,
        timestamp: Date.now()
      });

      // Add 1 credit for being in queue
      const currentCredits = playerCredits[name] || 0;
      await set(ref(database, `playerCredits/${name}`), currentCredits + 1);

      input.value = '';
    };

    // Credit management functions
    window.addCredits = async function() {
      const nameInput = document.getElementById('creditPlayerName');
      const amountInput = document.getElementById('creditAmount');
      const name = nameInput.value.trim();
      const amount = parseInt(amountInput.value) || 1;
      
      if (!name) return;

      const currentCredits = playerCredits[name] || 0;
      await set(ref(database, `playerCredits/${name}`), currentCredits + amount);
      
      nameInput.value = '';
      amountInput.value = '1';
    };

    window.removeCredits = async function() {
      const nameInput = document.getElementById('creditPlayerName');
      const amountInput = document.getElementById('creditAmount');
      const name = nameInput.value.trim();
      const amount = parseInt(amountInput.value) || 1;
      
      if (!name) return;

      const currentCredits = playerCredits[name] || 0;
      const newCredits = Math.max(0, currentCredits - amount);
      
      if (newCredits === 0) {
        await remove(ref(database, `playerCredits/${name}`));
      } else {
        await set(ref(database, `playerCredits/${name}`), newCredits);
      }
      
      nameInput.value = '';
      amountInput.value = '1';
    };

    // Allow Enter key to add player
    document.getElementById('newPlayerName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        window.addPlayer();
      }
    });

    // Toggle paid status
    window.togglePaid = async function(key, currentStatus) {
      const playerRef = ref(database, `queue/${key}`);
      await update(playerRef, { paid: !currentStatus });
    };

    // Delete player
    window.deletePlayer = async function(key) {
      if (confirm('Delete this player from queue?')) {
        const playerRef = ref(database, `queue/${key}`);
        await remove(playerRef);
      }
    };

    // Delete top pair
    window.deleteTopPair = async function() {
      if (queue.length === 0) return;
      
      if (confirm('Delete top 2 players from queue?')) {
        const toDelete = queue.slice(0, 2);
        for (const player of toDelete) {
          const playerRef = ref(database, `queue/${player.key}`);
          await remove(playerRef);
        }
      }
    };

    // Swap players
    window.swapPlayers = async function() {
      const pos1 = parseInt(document.getElementById('swapPos1').value) - 1;
      const pos2 = parseInt(document.getElementById('swapPos2').value) - 1;

      if (pos1 < 0 || pos2 < 0 || pos1 >= queue.length || pos2 >= queue.length) {
        alert('Invalid positions');
        return;
      }

      // Get current queue
      const snapshot = await get(queueRef);
      const queueArray = [];
      snapshot.forEach((child) => {
        queueArray.push({ key: child.key, ...child.val() });
      });

      // Swap
      [queueArray[pos1], queueArray[pos2]] = [queueArray[pos2], queueArray[pos1]];

      // Clear and rewrite
      await set(queueRef, null);
      for (const player of queueArray) {
        const { key, ...data } = player;
        await push(queueRef, data);
      }

      // Clear inputs
      document.getElementById('swapPos1').value = '';
      document.getElementById('swapPos2').value = '';
    };

    // Next pair playing with credit logic
    window.nextPairPlaying = async function() {
      if (queue.length < 2) {
        alert('Not enough players in queue');
        return;
      }

      const pair = queue.slice(0, 2);
      
      // If there are currently playing players, finish their game first
      if (currentlyPlaying.length > 0) {
        await finishCurrentGame();
      }

      // Set new pair as currently playing
      await set(currentlyPlayingRef, pair.map(p => ({ name: p.name })));

      // Process credits for each player
      for (const player of pair) {
        // Reduce 1 credit (moving from queue to playing)
        const currentCredits = playerCredits[player.name] || 0;
        const newCredits = Math.max(0, currentCredits - 1);
        
        if (newCredits === 0) {
          await remove(ref(database, `playerCredits/${player.name}`));
        } else {
          await set(ref(database, `playerCredits/${player.name}`), newCredits);
        }

        // Remove from queue
        const playerRef = ref(database, `queue/${player.key}`);
        await remove(playerRef);
      }
    };

    // Next solo playing with credit logic  
    window.nextSoloPlaying = async function() {
      if (queue.length < 1) {
        alert('No players in queue');
        return;
      }

      const soloPlayer = queue[0];
      
      // If there are currently playing players, finish their game first
      if (currentlyPlaying.length > 0) {
        await finishCurrentGame();
      }

      // Set solo player as currently playing
      await set(currentlyPlayingRef, [{ name: soloPlayer.name }]);

      // Process credits for the player
      const currentCredits = playerCredits[soloPlayer.name] || 0;
      const newCredits = Math.max(0, currentCredits - 1);
      
      if (newCredits === 0) {
        await remove(ref(database, `playerCredits/${soloPlayer.name}`));
      } else {
        await set(ref(database, `playerCredits/${soloPlayer.name}`), newCredits);
      }

      // Remove from queue
      const playerRef = ref(database, `queue/${soloPlayer.key}`);
      await remove(playerRef);
    };

    // Function to finish current game and handle credit logic
    async function finishCurrentGame() {
      if (currentlyPlaying.length === 0) return;

      // Add finished players to game history
      await push(gameHistoryRef, {
        players: currentlyPlaying.map(p => p.name),
        timestamp: Date.now()
      });

      // Auto-requeue players with remaining credits
      for (const player of currentlyPlaying) {
        const remainingCredits = playerCredits[player.name] || 0;
        
        if (remainingCredits > 0) {
          // Add back to end of queue
          await push(queueRef, {
            name: player.name,
            paid: true, // They have credits so mark as paid
            timestamp: Date.now()
          });
        }
      }
    }

    // Clear currently playing with credit logic
    window.clearCurrentPlayers = async function() {
      if (confirm('Finish current game and clear players?')) {
        await finishCurrentGame();
        await set(currentlyPlayingRef, null);
      }
    };
  </script>
</body>
</html>
