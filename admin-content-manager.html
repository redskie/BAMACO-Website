<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Content Manager - BAMACO</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="assets/tailwind-config.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Page Transitions -->
  <script src="assets/page-transitions.js"></script>
</head>

<body class="min-h-screen font-inter">
  <!-- Navigation will be injected here -->
  <div id="navbar-placeholder"></div>

  <!-- Admin Authentication Modal -->
  <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-bg-card border border-border-primary rounded-xl p-8 max-w-md w-full mx-4">
      <div class="text-center mb-6">
        <h2 class="text-2xl font-bold text-text-primary mb-2">üîê Admin Access Required</h2>
        <p class="text-text-secondary text-sm">Enter your admin credentials to access the content manager</p>
      </div>

      <form id="authForm">
        <div class="space-y-4">
          <div>
            <label for="adminFriendCode" class="block text-sm font-semibold text-text-primary mb-2">
              Friend Code
            </label>
            <input
              type="text"
              id="adminFriendCode"
              placeholder="Enter your friend code"
              class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200"
              required>
          </div>

          <div>
            <label for="adminPassword" class="block text-sm font-semibold text-text-primary mb-2">
              Password
            </label>
            <input
              type="password"
              id="adminPassword"
              placeholder="Enter your password"
              class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200"
              required>
          </div>
        </div>

        <div class="flex gap-3 mt-6">
          <button
            type="button"
            onclick="window.location.href='index.html'"
            class="flex-1 px-4 py-3 border border-border-primary text-text-primary rounded-lg hover:bg-bg-tertiary transition-colors">
            Cancel
          </button>
          <button
            type="submit"
            id="authSubmitBtn"
            class="flex-1 px-4 py-3 bg-accent-pink text-white rounded-lg hover-btn-primary disabled:bg-text-muted disabled:cursor-not-allowed">
            <span id="authBtnText">Authenticate</span>
            <span id="authSpinner" class="hidden">üîÑ</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Main Content -->
  <main id="mainContent" class="hidden container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4">
        <div>
          <h1 class="text-3xl sm:text-4xl font-bold text-text-primary mb-2">
            üëë Admin Content Manager
          </h1>
          <p class="text-text-secondary">Manage player profiles, guilds, and content across BAMACO</p>
        </div>

        <div class="flex items-center gap-4 mt-4 sm:mt-0">
          <div id="adminInfo" class="text-right">
            <p class="text-sm font-semibold text-text-primary" id="adminName">Loading...</p>
            <p class="text-xs text-text-muted" id="adminRole">Admin</p>
          </div>

          <button
            onclick="logout()"
            class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm">
            Logout
          </button>
        </div>
      </div>
    </div>

    <!-- Stats Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-bg-card border border-border-primary rounded-xl p-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-semibold text-text-secondary">Total Players</h3>
          <span class="text-2xl">üë•</span>
        </div>
        <p class="text-2xl font-bold text-text-primary" id="totalPlayers">0</p>
      </div>

      <div class="bg-bg-card border border-border-primary rounded-xl p-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-semibold text-text-secondary">Admin Accounts</h3>
          <span class="text-2xl">‚≠ê</span>
        </div>
        <p class="text-2xl font-bold text-text-primary" id="totalAdmins">0</p>
      </div>

      <div class="bg-bg-card border border-border-primary rounded-xl p-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-semibold text-text-secondary">Active Guilds</h3>
          <span class="text-2xl">üè∞</span>
        </div>
        <p class="text-2xl font-bold text-text-primary" id="totalGuilds">0</p>
      </div>

      <div class="bg-bg-card border border-border-primary rounded-xl p-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-semibold text-text-secondary">Published Articles</h3>
          <span class="text-2xl">üìÑ</span>
        </div>
        <p class="text-2xl font-bold text-text-primary" id="totalArticles">0</p>
      </div>
    </div>

    <!-- Player Management Section -->
    <div class="bg-bg-card border border-border-primary rounded-xl p-6 mb-8">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-text-primary">Player Management</h2>

        <div class="flex gap-3 mt-4 sm:mt-0">
          <div class="relative">
            <input
              type="text"
              id="playerSearch"
              placeholder="Search players..."
              class="pl-10 pr-4 py-2 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted">üîç</span>
          </div>

          <select
            id="playerFilter"
            class="px-4 py-2 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200">
            <option value="all">All Players</option>
            <option value="admins">Admins Only</option>
            <option value="regular">Regular Players</option>
            <option value="recent">Recent (7 days)</option>
          </select>
        </div>
      </div>

      <!-- Loading State -->
      <div id="playersLoading" class="text-center py-8">
        <div class="text-4xl mb-2">üéµ</div>
        <p class="text-text-muted">Loading players...</p>
      </div>

      <!-- Players Table -->
      <div id="playersTableContainer" class="hidden overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b border-border-primary">
              <th class="text-left py-3 px-4 font-semibold text-text-primary">Player</th>
              <th class="text-left py-3 px-4 font-semibold text-text-primary">IGN</th>
              <th class="text-left py-3 px-4 font-semibold text-text-primary">Rating</th>
              <th class="text-left py-3 px-4 font-semibold text-text-primary">Status</th>
              <th class="text-left py-3 px-4 font-semibold text-text-primary">Joined</th>
              <th class="text-left py-3 px-4 font-semibold text-text-primary">Actions</th>
            </tr>
          </thead>
          <tbody id="playersTableBody">
            <!-- Players will be populated here -->
          </tbody>
        </table>
      </div>

      <!-- Empty State -->
      <div id="playersEmpty" class="hidden text-center py-8">
        <div class="text-4xl mb-2">ü§î</div>
        <p class="text-text-muted">No players found matching your criteria</p>
      </div>
    </div>

    <!-- Action Log -->
    <div class="bg-bg-card border border-border-primary rounded-xl p-6">
      <h2 class="text-xl font-bold text-text-primary mb-4">Recent Admin Actions</h2>
      <div id="actionLog" class="space-y-2 max-h-64 overflow-y-auto">
        <!-- Action logs will be populated here -->
      </div>
    </div>
  </main>

  <!-- Player Edit Modal -->
  <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-bg-card border border-border-primary rounded-xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-text-primary">‚úèÔ∏è Edit Player Profile</h2>
        <button onclick="closeEditModal()" class="text-text-muted hover:text-text-primary transition-colors">
          <span class="text-xl">‚úï</span>
        </button>
      </div>

      <form id="editForm">
        <div id="editFormContent">
          <!-- Form content will be dynamically populated -->
        </div>

        <div class="flex gap-3 mt-6">
          <button
            type="button"
            onclick="closeEditModal()"
            class="flex-1 px-4 py-3 border border-border-primary text-text-primary rounded-lg hover:bg-bg-tertiary transition-colors">
            Cancel
          </button>
          <button
            type="submit"
            id="editSubmitBtn"
            class="flex-1 px-4 py-3 bg-accent-pink text-white rounded-lg hover-btn-primary disabled:bg-text-muted disabled:cursor-not-allowed">
            <span id="editBtnText">Save Changes</span>
            <span id="editSpinner" class="hidden">üîÑ</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, get, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCQ5eunqdZcHJx1Leaw7IYZdH3PkPjbctg",
      authDomain: "bamaco-queue.firebaseapp.com",
      databaseURL: "https://bamaco-queue-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "bamaco-queue",
      storageBucket: "bamaco-queue.firebasestorage.app",
      messagingSenderId: "683913605188",
      appId: "1:683913605188:web:2842c6031ea68dc5da8c11"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Simple database functions for admin panel
    const playersDB = {
      async getAllPlayers() {
        const snapshot = await get(ref(database, 'players'));
        return snapshot.val() || {};
      },
      async getPlayer(friendCode) {
        const snapshot = await get(ref(database, `players/${friendCode}`));
        return snapshot.val();
      },
      async updatePlayer(friendCode, updates) {
        await update(ref(database, `players/${friendCode}`), {
          ...updates,
          updatedAt: Date.now()
        });
        return { friendCode, ...updates };
      }
    };

    const guildsDB = {
      async getAllGuilds() {
        const snapshot = await get(ref(database, 'guilds'));
        return snapshot.val() || {};
      }
    };

    const articlesDB = {
      async getAllArticles() {
        const snapshot = await get(ref(database, 'articles'));
        return snapshot.val() || {};
      }
    };

    class AdminContentManager {
      constructor() {
        this.currentAdmin = null;
        this.players = [];
        this.filteredPlayers = [];
        this.editingPlayer = null;
        this.actionLog = [];

        this.init();
      }

      async init() {
        // Inject navbar
        this.injectNavbar();

        await this.authenticateAdmin();
      }

      injectNavbar() {
        const navbarHTML = `
          <nav class="sticky top-0 z-50 bg-gradient-to-r from-bg-secondary to-bg-card border-b-2 border-border-primary shadow-lg backdrop-blur-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <div class="flex justify-between items-center py-4">
                <div class="nav-brand z-50">
                  <h1 class="text-2xl sm:text-3xl font-extrabold bg-gradient-to-r from-accent-pink to-accent-purple bg-clip-text text-transparent">BAMACO</h1>
                  <span class="block text-xs text-text-secondary mt-[-4px]">Admin Panel</span>
                </div>
                <a href="index.html" class="text-text-secondary hover:text-text-primary transition-colors px-4 py-2 rounded-lg border border-border-primary hover:bg-bg-tertiary">‚Üê Back to Site</a>
              </div>
            </div>
          </nav>
        `;

        const placeholder = document.getElementById('navbar-placeholder');
        if (placeholder) {
          placeholder.innerHTML = navbarHTML;
        }
      }

      async authenticateAdmin() {
        // Check if already authenticated
        const session = JSON.parse(localStorage.getItem('bamaco_session') || 'null');

        if (session && session.expiresAt > Date.now()) {
          // Verify admin status
          try {
            const user = await playersDB.getPlayer(session.user.friendCode);
            if (user && user.isAdmin) {
              this.currentAdmin = user;
              await this.showMainContent();
              return;
            }
          } catch (error) {
            console.error('Session verification failed:', error);
          }
        }

        // Show authentication modal
        document.getElementById('authModal').style.display = 'flex';
        document.getElementById('authForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleLogin();
        });
      }

      async handleLogin() {
        const friendCode = document.getElementById('adminFriendCode').value.replace(/\D/g, '');
        const password = document.getElementById('adminPassword').value;

        const btn = document.getElementById('authSubmitBtn');
        const text = document.getElementById('authBtnText');
        const spinner = document.getElementById('authSpinner');

        // Show loading
        btn.disabled = true;
        text.textContent = 'Authenticating...';
        spinner.classList.remove('hidden');

        try {
          // Get user from Firebase
          const user = await playersDB.getPlayer(friendCode);

          if (!user) {
            throw new Error('User not found');
          }

          if (!user.isAdmin) {
            throw new Error('Access denied: Admin privileges required');
          }

          // Simple password verification - in production use proper password hashing
          // For demo purposes, accept any non-empty password for admin users
          if (!password || password.length < 3) {
            throw new Error('Password must be at least 3 characters');
          }

          this.currentAdmin = user;

          // Update session
          const session = {
            user: {
              friendCode: user.friendCode,
              ign: user.ign,
              isAdmin: true,
              adminRole: user.adminRole
            },
            expiresAt: Date.now() + (30 * 24 * 60 * 60 * 1000) // 30 days
          };
          localStorage.setItem('bamaco_session', JSON.stringify(session));

          // Hide auth modal and show main content
          document.getElementById('authModal').style.display = 'none';
          await this.showMainContent();

        } catch (error) {
          alert(error.message || 'Authentication failed');

          // Reset button
          btn.disabled = false;
          text.textContent = 'Authenticate';
          spinner.classList.add('hidden');
        }
      }

      async showMainContent() {
        // Update admin info
        document.getElementById('adminName').textContent = this.currentAdmin.ign;
        document.getElementById('adminRole').textContent = this.currentAdmin.adminRole?.toUpperCase() || 'ADMIN';

        // Show main content
        document.getElementById('mainContent').classList.remove('hidden');

        // Load data
        await this.loadDashboardData();
        await this.loadPlayers();

        // Set up event listeners
        this.setupEventListeners();

        this.logAction(`${this.currentAdmin.ign} logged into admin panel`);
      }

      setupEventListeners() {
        // Player search
        document.getElementById('playerSearch').addEventListener('input', (e) => {
          this.filterPlayers();
        });

        // Player filter
        document.getElementById('playerFilter').addEventListener('change', (e) => {
          this.filterPlayers();
        });

        // Edit form submission
        document.getElementById('editForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handlePlayerUpdate();
        });
      }

      async loadDashboardData() {
        try {
          const [players, guilds, articles] = await Promise.all([
            playersDB.getAllPlayers(),
            guildsDB.getAllGuilds(),
            articlesDB.getAllArticles()
          ]);

          const playerList = Object.values(players || {});
          const guildList = Object.values(guilds || {});
          const articleList = Object.values(articles || {});

          document.getElementById('totalPlayers').textContent = playerList.length;
          document.getElementById('totalAdmins').textContent = playerList.filter(p => p.isAdmin).length;
          document.getElementById('totalGuilds').textContent = guildList.length;
          document.getElementById('totalArticles').textContent = articleList.length;

        } catch (error) {
          console.error('Failed to load dashboard data:', error);
        }
      }

      async loadPlayers() {
        try {
          document.getElementById('playersLoading').classList.remove('hidden');
          document.getElementById('playersTableContainer').classList.add('hidden');

          const playersData = await playersDB.getAllPlayers();
          this.players = Object.values(playersData || {});

          this.filterPlayers();

        } catch (error) {
          console.error('Failed to load players:', error);
          this.showPlayersEmpty();
        }
      }

      filterPlayers() {
        const searchTerm = document.getElementById('playerSearch').value.toLowerCase();
        const filter = document.getElementById('playerFilter').value;

        let filtered = this.players;

        // Apply search filter
        if (searchTerm) {
          filtered = filtered.filter(player =>
            player.ign?.toLowerCase().includes(searchTerm) ||
            player.name?.toLowerCase().includes(searchTerm) ||
            player.friendCode?.includes(searchTerm)
          );
        }

        // Apply category filter
        switch (filter) {
          case 'admins':
            filtered = filtered.filter(player => player.isAdmin);
            break;
          case 'regular':
            filtered = filtered.filter(player => !player.isAdmin);
            break;
          case 'recent':
            const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            filtered = filtered.filter(player =>
              player.createdAt && player.createdAt > weekAgo
            );
            break;
        }

        this.filteredPlayers = filtered;
        this.renderPlayersTable();
      }

      renderPlayersTable() {
        const container = document.getElementById('playersTableContainer');
        const tbody = document.getElementById('playersTableBody');
        const loading = document.getElementById('playersLoading');
        const empty = document.getElementById('playersEmpty');

        loading.classList.add('hidden');

        if (this.filteredPlayers.length === 0) {
          container.classList.add('hidden');
          empty.classList.remove('hidden');
          return;
        }

        empty.classList.add('hidden');
        container.classList.remove('hidden');

        tbody.innerHTML = this.filteredPlayers.map(player => {
          const adminBadge = player.isAdmin ?
            `<span class="text-xs px-2 py-1 rounded-full bg-accent-pink text-white">${player.adminRole?.toUpperCase() || 'ADMIN'}</span>` :
            '<span class="text-xs px-2 py-1 rounded-full bg-gray-200 text-gray-700">PLAYER</span>';

          return `
            <tr class="border-b border-border-primary hover:bg-bg-secondary/50 transition-colors">
              <td class="py-3 px-4">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 rounded-full bg-accent-pink text-white flex items-center justify-center text-sm font-bold">
                    ${player.ign?.charAt(0) || 'P'}
                  </div>
                  <div>
                    <p class="font-semibold text-text-primary">${player.name || player.ign || 'Unknown'}</p>
                    <p class="text-xs text-text-muted">FC: ${this.formatFriendCode(player.friendCode)}</p>
                  </div>
                </div>
              </td>
              <td class="py-3 px-4">
                <p class="font-medium text-text-primary">${player.ign || 'N/A'}</p>
              </td>
              <td class="py-3 px-4">
                <p class="text-text-primary">${player.rating || '0'}</p>
                <p class="text-xs text-text-muted">${player.rank || 'Unranked'}</p>
              </td>
              <td class="py-3 px-4">${adminBadge}</td>
              <td class="py-3 px-4">
                <p class="text-text-primary">${player.joined || 'N/A'}</p>
              </td>
              <td class="py-3 px-4">
                <div class="flex gap-2">
                  <button
                    onclick="window.adminManager.editPlayer('${player.friendCode}')"
                    class="px-3 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 transition-colors">
                    Edit
                  </button>
                  <button
                    onclick="window.adminManager.viewPlayer('${player.friendCode}')"
                    class="px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600 transition-colors">
                    View
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }

      showPlayersEmpty() {
        document.getElementById('playersLoading').classList.add('hidden');
        document.getElementById('playersTableContainer').classList.add('hidden');
        document.getElementById('playersEmpty').classList.remove('hidden');
      }

      formatFriendCode(code) {
        if (!code) return 'N/A';
        return String(code).replace(/\D/g, '');
      }

      editPlayer(friendCode) {
        const player = this.players.find(p => p.friendCode === friendCode);
        if (!player) return;

        this.editingPlayer = player;
        this.showEditModal(player);
      }

      showEditModal(player) {
        const formContent = document.getElementById('editFormContent');

        formContent.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="editIgn" class="block text-sm font-semibold text-text-primary mb-2">IGN</label>
              <input
                type="text"
                id="editIgn"
                value="${player.ign || ''}"
                class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200">
            </div>

            <div>
              <label for="editName" class="block text-sm font-semibold text-text-primary mb-2">Real Name</label>
              <input
                type="text"
                id="editName"
                value="${player.name || ''}"
                class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200">
            </div>

            <div>
              <label for="editRating" class="block text-sm font-semibold text-text-primary mb-2">Rating</label>
              <input
                type="text"
                id="editRating"
                value="${player.rating || ''}"
                class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200">
            </div>

            <div>
              <label for="editRank" class="block text-sm font-semibold text-text-primary mb-2">Rank</label>
              <input
                type="text"
                id="editRank"
                value="${player.rank || ''}"
                class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200">
            </div>

            <div>
              <label for="editTitle" class="block text-sm font-semibold text-text-primary mb-2">Title</label>
              <input
                type="text"
                id="editTitle"
                value="${player.title || ''}"
                class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200">
            </div>

            <div>
              <label for="editAge" class="block text-sm font-semibold text-text-primary mb-2">Age</label>
              <input
                type="text"
                id="editAge"
                value="${player.age || ''}"
                class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200">
            </div>

            <div class="md:col-span-2">
              <label for="editMotto" class="block text-sm font-semibold text-text-primary mb-2">Motto</label>
              <input
                type="text"
                id="editMotto"
                value="${player.motto || ''}"
                class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200">
            </div>

            <div class="md:col-span-2">
              <label for="editBio" class="block text-sm font-semibold text-text-primary mb-2">Bio</label>
              <textarea
                id="editBio"
                rows="3"
                class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200">${player.bio || ''}</textarea>
            </div>

            <div class="md:col-span-2 border-t border-border-primary pt-4">
              <h4 class="font-semibold text-text-primary mb-3">Admin Settings</h4>
              <div class="flex items-center gap-4">
                <label class="flex items-center gap-2">
                  <input
                    type="checkbox"
                    id="editIsAdmin"
                    ${player.isAdmin ? 'checked' : ''}
                    class="w-4 h-4 text-accent-pink">
                  <span class="text-sm text-text-primary">Admin Privileges</span>
                </label>

                <select
                  id="editAdminRole"
                  ${!player.isAdmin ? 'disabled' : ''}
                  class="px-3 py-2 border border-border-primary rounded bg-bg-secondary text-sm">
                  <option value="admin" ${player.adminRole === 'admin' ? 'selected' : ''}>Admin</option>
                  <option value="moderator" ${player.adminRole === 'moderator' ? 'selected' : ''}>Moderator</option>
                  <option value="owner" ${player.adminRole === 'owner' ? 'selected' : ''}>Owner</option>
                </select>
              </div>
            </div>
          </div>
        `;

        // Handle admin checkbox
        const isAdminCheckbox = document.getElementById('editIsAdmin');
        const adminRoleSelect = document.getElementById('editAdminRole');

        if (isAdminCheckbox && adminRoleSelect) {
          isAdminCheckbox.addEventListener('change', (e) => {
            adminRoleSelect.disabled = !e.target.checked;
          });
        }

        document.getElementById('editModal').classList.remove('hidden');
      }

      async handlePlayerUpdate() {
        const btn = document.getElementById('editSubmitBtn');
        const text = document.getElementById('editBtnText');
        const spinner = document.getElementById('editSpinner');

        // Show loading
        btn.disabled = true;
        text.textContent = 'Saving...';
        spinner.classList.remove('hidden');

        try {
          const updatedData = {
            ign: document.getElementById('editIgn').value.trim(),
            name: document.getElementById('editName').value.trim(),
            rating: document.getElementById('editRating').value.trim(),
            rank: document.getElementById('editRank').value.trim(),
            title: document.getElementById('editTitle').value.trim(),
            age: document.getElementById('editAge').value.trim(),
            motto: document.getElementById('editMotto').value.trim(),
            bio: document.getElementById('editBio').value.trim(),
            isAdmin: document.getElementById('editIsAdmin').checked,
            adminRole: document.getElementById('editIsAdmin').checked ? document.getElementById('editAdminRole').value : null,
            updatedAt: Date.now()
          };

          await playersDB.updatePlayer(this.editingPlayer.friendCode, updatedData);

          this.logAction(`Updated player profile: ${this.editingPlayer.ign} (${this.editingPlayer.friendCode})`);

          // Refresh data
          await this.loadPlayers();
          await this.loadDashboardData();

          this.closeEditModal();

        } catch (error) {
          console.error('Update failed:', error);
          alert('Failed to update player profile: ' + error.message);

          // Reset button
          btn.disabled = false;
          text.textContent = 'Save Changes';
          spinner.classList.add('hidden');
        }
      }

      closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
        this.editingPlayer = null;
      }

      viewPlayer(friendCode) {
        window.open(`player-profile.html?id=${friendCode}`, '_blank');
      }

      logAction(action) {
        const timestamp = new Date().toLocaleString();
        this.actionLog.unshift({
          action,
          timestamp,
          admin: this.currentAdmin.ign
        });

        // Keep only last 50 actions
        if (this.actionLog.length > 50) {
          this.actionLog = this.actionLog.slice(0, 50);
        }

        this.renderActionLog();
      }

      renderActionLog() {
        const container = document.getElementById('actionLog');

        if (this.actionLog.length === 0) {
          container.innerHTML = '<p class="text-text-muted text-sm">No recent actions</p>';
          return;
        }

        container.innerHTML = this.actionLog.slice(0, 10).map(log => `
          <div class="flex justify-between items-center py-2 px-3 bg-bg-secondary rounded-lg">
            <p class="text-sm text-text-primary">${log.action}</p>
            <p class="text-xs text-text-muted">${log.timestamp}</p>
          </div>
        `).join('');
      }
    }

    // Global functions
    window.adminManager = new AdminContentManager();

    window.logout = () => {
      localStorage.removeItem('bamaco_session');
      window.location.href = 'index.html';
    };

    window.closeEditModal = () => {
      window.adminManager.closeEditModal();
    };
  </script>
</body>
</html>
