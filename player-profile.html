<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Player Profile - BAMACO</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="assets/tailwind-config.js"></script>
    <script>tailwind.config = window.BAMACO_TAILWIND_CONFIG;</script>

    <link rel="stylesheet" href="assets/styles.css" />
  </head>

  <body class="bg-bg-primary text-text-primary font-sans antialiased overflow-x-hidden">
    <!-- Navbar will be dynamically generated by navbar.js -->

    <!-- Loading State -->
    <div id="loading-state" class="fixed inset-0 bg-bg-primary z-50 flex items-center justify-center">
      <div class="text-center">
        <div class="w-16 h-16 border-4 border-accent-pink border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-text-secondary">Loading player profile...</p>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="hidden fixed inset-0 bg-bg-primary z-50 flex items-center justify-center">
      <div class="text-center max-w-md px-4">
        <div class="text-6xl mb-4">üòï</div>
        <h2 class="text-2xl font-bold text-text-primary mb-2">Player Not Found</h2>
        <p class="text-text-secondary mb-6" id="error-message">The requested player profile could not be found.</p>
        <a href="players.html" class="inline-block bg-accent-pink hover:bg-accent-purple text-white font-bold py-3 px-6 rounded-lg transition-colors">
          Browse All Players
        </a>
      </div>
    </div>

    <!-- Main Content -->
    <main id="main-content" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Profile Header Card -->
      <div class="bg-bg-card p-6 rounded-lg border border-border-primary mb-8">
        <div class="w-32 h-32 flex items-center justify-center text-4xl font-bold mx-auto mb-4 overflow-hidden" id="player-avatar">
          <span id="avatar-letter"></span>
        </div>
        <div class="text-center">
          <h2 class="text-3xl font-bold mb-2 text-text-primary" id="player-name"></h2>
          <p class="text-text-secondary mb-6" id="player-title"></p>
          <div class="flex flex-wrap justify-center gap-8">
            <div class="text-center">
              <span class="block text-text-secondary text-sm mb-1">Rating</span>
              <span class="text-2xl font-bold text-text-primary" id="player-rating"></span>
            </div>
            <div class="text-center">
              <span class="block text-text-secondary text-sm mb-1">Rank</span>
              <span class="text-2xl font-bold text-text-primary" id="player-rank"></span>
            </div>
            <div class="text-center">
              <span class="block text-text-secondary text-sm mb-1">Joined</span>
              <span class="text-2xl font-bold text-text-primary" id="player-joined"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="space-y-8">
        <!-- Player Information -->
        <section>
          <h3 class="text-2xl font-bold mb-4 text-text-primary border-b border-border-primary pb-2">Player Information</h3>
          <div class="bg-bg-card p-6 rounded-lg border border-border-primary">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              <div>
                <strong class="text-text-secondary block mb-2">Name:</strong>
                <p class="text-text-primary" id="player-full-name"></p>
              </div>
              <div>
                <strong class="text-text-secondary block mb-2">MaiMai Friend Code:</strong>
                <p class="text-text-primary font-mono" id="player-friend-code"></p>
              </div>
              <div>
                <strong class="text-text-secondary block mb-2">Nickname:</strong>
                <p class="text-text-primary" id="player-nickname"></p>
              </div>
              <div>
                <strong class="text-text-secondary block mb-2">Title:</strong>
                <p class="text-text-primary" id="player-title-info"></p>
              </div>
              <div>
                <strong class="text-text-secondary block mb-2">Motto:</strong>
                <p class="text-text-primary" id="player-motto"></p>
              </div>
              <div>
                <strong class="text-text-secondary block mb-2">Age:</strong>
                <p class="text-text-primary" id="player-age"></p>
              </div>
              <div id="trophy-container" class="hidden">
                <strong class="text-text-secondary block mb-2">Trophy:</strong>
                <p class="text-text-primary" id="player-trophy"></p>
              </div>
            </div>
          </div>
        </section>

        <!-- About Section -->
        <section id="bio-section">
          <h3 class="text-2xl font-bold mb-4 text-text-primary border-b border-border-primary pb-2">About</h3>
          <div class="bg-bg-card p-6 rounded-lg border border-border-primary">
            <p class="text-text-primary leading-relaxed" id="player-bio"></p>
          </div>
        </section>

        <!-- Guild Affiliation -->
        <section id="guild-section" class="hidden">
          <h3 class="text-2xl font-bold mb-4 text-text-primary border-b border-border-primary pb-2">Guild Affiliation</h3>
          <div class="bg-bg-card p-6 rounded-lg border border-border-primary">
            <div class="flex flex-col items-center text-center gap-4">
              <div class="w-20 h-20 rounded-full bg-bg-tertiary flex items-center justify-center text-3xl font-bold overflow-hidden" id="guild-emblem-container">
                <span id="guild-emblem-letter"></span>
              </div>
              <div>
                <h4 class="text-xl font-bold mb-2">
                  <a class="text-text-primary hover:text-accent-primary transition-colors" id="guild-link" href=""></a>
                </h4>
                <p class="text-text-muted text-sm" id="guild-motto"></p>
              </div>
            </div>
          </div>
        </section>

        <!-- Achievements -->
        <section id="achievements-section" class="hidden">
          <h3 class="text-2xl font-bold mb-4 text-text-primary border-b border-border-primary pb-2">Achievements</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="achievements-container"></div>
        </section>

        <!-- Published Articles -->
        <section id="articles-section" class="hidden">
          <h3 class="text-2xl font-bold mb-4 text-text-primary border-b border-border-primary pb-2">Published Guides</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="articles-container"></div>
        </section>

        <!-- Edit Profile Button (shown to owner) -->
        <div id="edit-profile-section" class="hidden text-center">
          <a href="#" id="edit-profile-btn" class="inline-flex items-center gap-2 bg-bg-tertiary hover:bg-accent-pink text-text-primary hover:text-white px-6 py-3 rounded-lg transition-colors">
            <span>‚úèÔ∏è</span>
            <span>Edit Profile</span>
          </a>
        </div>
      </div>
    </main>

    <footer class="border-t border-border-primary py-6 mt-12 bg-bg-secondary">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <p class="text-center text-text-secondary">
          &copy; 2026 BAMACO - Bataan MaiMai Community. All rights reserved.
        </p>
      </div>
    </footer>

    <script src="assets/page-transitions.js"></script>
    <script src="assets/script.js"></script>
    <script src="assets/navbar.js"></script>

    <script type="module">
      import { playersDB } from './assets/players-db.js';

      // Create admin badge based on admin role
      function createAdminBadge(adminRole = 'admin') {
        const badges = {
          'owner': { icon: 'üëë', label: 'OWNER', class: 'admin-badge-owner' },
          'admin': { icon: '‚≠ê', label: 'ADMIN', class: 'admin-badge-admin' },
          'moderator': { icon: 'üõ°Ô∏è', label: 'MOD', class: 'admin-badge-mod' }
        };

        const badge = badges[adminRole.toLowerCase()] || badges['admin'];

        return `
          <div class="admin-badge ${badge.class}" style="position: relative; display: inline-block; margin-left: 8px;">
            <span class="admin-badge-icon">${badge.icon}</span>
            <span class="admin-badge-label">${badge.label}</span>
          </div>
        `;
      }

      // Get player ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const playerId = urlParams.get('id') || urlParams.get('friendCode');

      const loadingState = document.getElementById('loading-state');
      const errorState = document.getElementById('error-state');
      const mainContent = document.getElementById('main-content');

      async function loadPlayerProfile() {
        if (!playerId) {
          showError('No player ID specified');
          return;
        }

        try {
          const player = await playersDB.getPlayer(playerId);

          if (!player) {
            showError('Player not found');
            return;
          }

          // Populate the page
          populateProfile(player);

          // Check if current user owns this profile
          checkOwnership(player);

          // Subscribe to real-time updates
          playersDB.subscribeToPlayer(playerId, (updatedPlayer) => {
            if (updatedPlayer) {
              populateProfile(updatedPlayer);
            }
          });

          // Show content
          loadingState.classList.add('hidden');
          mainContent.classList.remove('hidden');

        } catch (error) {
          console.error('Error loading player:', error);
          showError('Failed to load player profile');
        }
      }

      function populateProfile(player) {
        // Update page title
        document.title = `${player.ign} - BAMACO`;

        // Avatar with consistent styling and error handling
        const avatarEl = document.getElementById('player-avatar');
        const avatarLetter = document.getElementById('avatar-letter');

        if (player.avatarImage && player.avatarImage.trim()) {
          // Create image element with error fallback
          const img = document.createElement('img');
          img.src = player.avatarImage;
          img.alt = player.ign || 'Player Avatar';
          img.className = 'w-full h-full object-cover';
          img.onerror = function() {
            // Fallback to initials on image error
            avatarEl.style.backgroundImage = '';
            avatarEl.className = 'w-32 h-32 flex items-center justify-center text-4xl font-bold text-white mx-auto mb-4';
            avatarLetter.textContent = (player.ign || 'P').substring(0, 2).toUpperCase();
            avatarLetter.style.display = 'block';
          };
          img.onload = function() {
            avatarLetter.style.display = 'none';
          };
          avatarEl.appendChild(img);
          avatarEl.className = 'w-32 h-32 overflow-hidden mx-auto mb-4';
        } else {
          avatarEl.className = 'w-32 h-32 flex items-center justify-center text-4xl font-bold text-white mx-auto mb-4';
          avatarLetter.textContent = (player.ign || 'P').substring(0, 2).toUpperCase();
          avatarLetter.style.display = 'block';
        }

        // Basic info
        document.getElementById('player-name').textContent = player.ign || 'Unknown';

        // Add admin badge to name if user is admin
        if (player.isAdmin) {
          const nameElement = document.getElementById('player-name');
          const badge = createAdminBadge(player.adminRole || 'admin');
          nameElement.insertAdjacentHTML('afterend', badge);
        }

        document.getElementById('player-title').textContent = player.title || player.motto || '';
        document.getElementById('player-rating').textContent = player.rating || '0';
        document.getElementById('player-rank').textContent = player.rank || 'Unranked';
        document.getElementById('player-joined').textContent = player.joined || 'N/A';

        // Details
        document.getElementById('player-full-name').textContent = player.name || player.ign || 'Unknown';
        document.getElementById('player-friend-code').textContent = formatFriendCode(player.friendCode);
        document.getElementById('player-nickname').textContent = player.nickname || 'N/A';
        document.getElementById('player-title-info').textContent = player.title || player.trophy || 'N/A';
        document.getElementById('player-motto').textContent = player.motto || 'N/A';
        document.getElementById('player-age').textContent = player.age || 'N/A';

        // Trophy
        if (player.trophy) {
          document.getElementById('trophy-container').classList.remove('hidden');
          document.getElementById('player-trophy').textContent = player.trophy;
        } else {
          document.getElementById('trophy-container').classList.add('hidden');
        }

        // Bio
        const bioSection = document.getElementById('bio-section');
        if (player.bio) {
          document.getElementById('player-bio').textContent = player.bio;
          bioSection.classList.remove('hidden');
        } else {
          bioSection.classList.add('hidden');
        }

        // Guild
        const guildSection = document.getElementById('guild-section');
        if (player.guildId) {
          guildSection.classList.remove('hidden');
          // TODO: Load guild data from Firebase
          document.getElementById('guild-emblem-letter').textContent = player.guildId.charAt(0).toUpperCase();
          document.getElementById('guild-link').textContent = player.guildId;
          document.getElementById('guild-link').href = `guild-profile.html?id=${player.guildId}`;
        } else {
          guildSection.classList.add('hidden');
        }

        // Achievements
        const achievementsSection = document.getElementById('achievements-section');
        const achievementsContainer = document.getElementById('achievements-container');

        if (player.achievements && player.achievements.length > 0) {
          achievementsSection.classList.remove('hidden');
          achievementsContainer.innerHTML = player.achievements.map(a => `
            <div class="bg-bg-card border border-border-primary rounded-lg p-4 text-center">
              <div class="text-4xl mb-2">${a.icon || 'üèÜ'}</div>
              <div class="font-bold text-text-primary mb-1">${a.name}</div>
              <div class="text-sm text-text-secondary">${a.description || ''}</div>
            </div>
          `).join('');
        } else {
          achievementsSection.classList.add('hidden');
        }

        // Articles
        const articlesSection = document.getElementById('articles-section');
        const articlesContainer = document.getElementById('articles-container');

        if (player.articles && player.articles.length > 0) {
          articlesSection.classList.remove('hidden');
          articlesContainer.innerHTML = player.articles.map(a => `
            <div class="bg-bg-card border border-border-primary rounded-lg p-4 hover:bg-bg-card-hover transition-all duration-300 cursor-pointer"
                 onclick="window.location.href='article.html?id=${a.slug || a.id}'">
              <h3 class="text-lg font-bold mb-2 text-text-primary">${a.title}</h3>
              <p class="text-text-secondary text-sm mb-3">${a.excerpt || ''}</p>
              <div class="flex justify-between items-center text-xs text-text-muted">
                <span>By ${player.ign}</span>
                <span class="px-2 py-1 bg-bg-tertiary rounded">${a.category || 'Guide'}</span>
              </div>
            </div>
          `).join('');
        } else {
          articlesSection.classList.add('hidden');
        }
      }

      function checkOwnership(player) {
        // Check if current user owns this profile
        const session = JSON.parse(localStorage.getItem('bamaco_session') || '{}');
        const storedEditKey = localStorage.getItem('profileEditKey');

        if (session.user?.friendCode === player.friendCode ||
            (storedEditKey && storedEditKey === player.editKey)) {
          document.getElementById('edit-profile-section').classList.remove('hidden');
          document.getElementById('edit-profile-btn').href = `edit-profile.html?id=${player.friendCode}`;
        }
      }

      function formatFriendCode(code) {
        if (!code) return 'N/A';
        return String(code).replace(/\D/g, '');
      }

      function showError(message) {
        document.getElementById('error-message').textContent = message;
        loadingState.classList.add('hidden');
        errorState.classList.remove('hidden');
      }

      // Apply marquee effect for long titles
      function applyMarqueeToElement(element, text, maxLength = 25) {
        if (text && text.length >= maxLength) {
          element.innerHTML = `
            <div class="marquee-container overflow-hidden">
              <span class="marquee-content inline-block animate-marquee whitespace-nowrap">${text}</span>
            </div>
          `;
        } else {
          element.textContent = text || '';
        }
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', loadPlayerProfile);
    </script>

    <style>
      @keyframes marquee {
        0% { transform: translateX(0); }
        100% { transform: translateX(-50%); }
      }
      .animate-marquee {
        animation: marquee 10s linear infinite;
      }
      .marquee-container {
        max-width: 300px;
        margin: 0 auto;
      }
    </style>
  </body>
</html>
