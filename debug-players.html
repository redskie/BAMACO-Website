<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Players - BAMACO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="assets/tailwind-config.js"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">Debug Players Database</h1>

        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-lg font-semibold mb-4">Console Output</h2>
            <div id="console-output" class="bg-gray-100 p-4 rounded font-mono text-sm min-h-32 overflow-auto"></div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-lg font-semibold mb-4">Test Actions</h2>
            <div class="space-x-4">
                <button id="test-connection" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Test Connection
                </button>
                <button id="test-subscription" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Test Subscription
                </button>
                <button id="test-create" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    Create Test Player
                </button>
                <button id="clear-console" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    Clear Console
                </button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">Players Data</h2>
            <div id="players-data" class="text-sm"></div>
        </div>
    </div>

    <script type="module">
        import { playersDB } from './assets/players-db.js';

        const consoleOutput = document.getElementById('console-output');
        const playersData = document.getElementById('players-data');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-600',
                error: 'text-red-600',
                success: 'text-green-600',
                warn: 'text-yellow-600'
            };

            const div = document.createElement('div');
            div.className = colors[type];
            div.textContent = `[${timestamp}] ${message}`;
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;

            console.log(`[DEBUG] ${message}`);
        }

        // Override console methods to capture output
        const originalLog = console.log;
        const originalError = console.error;

        console.log = (...args) => {
            originalLog.apply(console, args);
            log(args.join(' '), 'info');
        };

        console.error = (...args) => {
            originalError.apply(console, args);
            log(args.join(' '), 'error');
        };

        // Test connection
        document.getElementById('test-connection').addEventListener('click', async () => {
            log('Testing Firebase connection...', 'info');
            try {
                // Test if we can import and access the database
                log('✓ Players DB module imported successfully', 'success');
                log(`✓ Players DB methods: ${Object.getOwnPropertyNames(Object.getPrototypeOf(playersDB)).join(', ')}`, 'info');
            } catch (error) {
                log(`✗ Connection test failed: ${error.message}`, 'error');
            }
        });

        // Test subscription
        document.getElementById('test-subscription').addEventListener('click', () => {
            log('Setting up players subscription...', 'info');
            try {
                const unsubscribe = playersDB.subscribeToPlayers((players) => {
                    log(`✓ Subscription callback fired with ${players.length} players`, 'success');

                    playersData.innerHTML = players.length === 0 ?
                        '<p class="text-gray-500">No players found</p>' :
                        players.map(player => `
                            <div class="border p-2 rounded mb-2">
                                <strong>${player.ign || 'No IGN'}</strong>
                                (FC: ${player.friendCode || 'No FC'})
                                <br><small>Public: ${player.isPublic !== false ? 'Yes' : 'No'}</small>
                            </div>
                        `).join('');
                });

                log('✓ Subscription set up successfully', 'success');

                // Clean up after 30 seconds
                setTimeout(() => {
                    unsubscribe();
                    log('Subscription cleaned up', 'info');
                }, 30000);

            } catch (error) {
                log(`✗ Subscription failed: ${error.message}`, 'error');
            }
        });

        // Test creating a player
        document.getElementById('test-create').addEventListener('click', async () => {
            log('Creating test player...', 'info');
            try {
                const testPlayer = {
                    friendCode: '999999999',
                    ign: 'TestPlayer',
                    name: 'Test Player',
                    isPublic: true,
                    createdAt: new Date(),
                    rating: '14000',
                    rank: 'Expert'
                };

                await playersDB.createPlayer(testPlayer);
                log('✓ Test player created successfully', 'success');
            } catch (error) {
                log(`✗ Failed to create test player: ${error.message}`, 'error');
            }
        });

        // Clear console
        document.getElementById('clear-console').addEventListener('click', () => {
            consoleOutput.innerHTML = '';
            playersData.innerHTML = '';
        });

        // Auto-run connection test
        log('Debug page loaded, running initial tests...', 'info');
        document.getElementById('test-connection').click();
    </script>
</body>
</html>
