<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Profile - BAMACO</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="assets/tailwind-config.js"></script>
  <script>tailwind.config = window.BAMACO_TAILWIND_CONFIG;</script>
  <script src="assets/loading-optimizer.js"></script>

  <link rel="stylesheet" href="assets/styles.css">
</head>
<body class="bg-bg-primary text-text-primary font-sans antialiased">
  <!-- Navigation -->
  <!-- Navbar will be dynamically generated by navbar.js -->

  <div class="max-w-4xl mx-auto px-4 sm:px-6 py-8 sm:py-12">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl sm:text-4xl lg:text-5xl font-black text-text-primary mb-2">Create Your Profile</h1>
      <p class="text-text-muted text-base sm:text-lg">Join the BAMACO community! Your profile will be created automatically.</p>
    </div>

    <!-- Profile Creation Form -->
    <div class="bg-bg-card border border-border-primary rounded-xl p-6 sm:p-8 mb-8">
      <form id="profileForm" class="space-y-6">

        <!-- MaiMai Friend Code (Required) -->
        <div>
          <label for="friendCode" class="block text-sm font-semibold text-text-primary mb-2">
            MaiMai Friend Code <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <input
              type="text"
              id="friendCode"
              name="friendCode"
              placeholder="Enter your friend code"
              class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200"
              required>
            <div id="friendCodeStatus" class="mt-2 text-sm hidden">
              <div id="friendCodeLoading" class="flex items-center text-text-muted">
                <svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Validating friend code...
              </div>
              <div id="friendCodeValid" class="text-green-600 hidden">‚úÖ Valid friend code!</div>
              <div id="friendCodeInvalid" class="text-red-500 hidden">‚ùå Invalid friend code or player not found</div>
            </div>
          </div>
          <p class="text-xs text-text-muted mt-1">
            Your MaiMai friend code. We'll automatically get your IGN, rating, and avatar from the game.
          </p>
        </div>

        <!-- API Retrieved Data Display -->
        <div id="apiDataDisplay" class="hidden bg-bg-tertiary border border-border-primary rounded-lg p-4">
          <h3 class="font-semibold text-text-primary mb-3">üì° Retrieved from MaiMai API:</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
            <div><strong>IGN:</strong> <span id="apiIgn">-</span></div>
            <div><strong>Rating:</strong> <span id="apiRating">-</span></div>
            <div><strong>Title:</strong> <span id="apiTitle">-</span></div>
            <div><strong>Trophy:</strong> <span id="apiTrophy">-</span></div>
          </div>
        </div>

        <!-- Name (Optional) -->
        <div>
          <label for="fullName" class="block text-sm font-semibold text-text-primary mb-2">
            Real Name (Optional)
          </label>
          <input
            type="text"
            id="fullName"
            name="fullName"
            placeholder="Leave blank for privacy (will show as REDACTED)"
            class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200">
          <p class="text-xs text-text-muted mt-1">
            Your real name. Leave blank if you prefer privacy - it will show as "REDACTED".
          </p>
        </div>

        <!-- Age (Required) -->
        <div>
          <label for="age" class="block text-sm font-semibold text-text-primary mb-2">
            Age <span class="text-red-500">*</span>
          </label>
          <input
            type="number"
            id="age"
            name="age"
            min="13"
            max="100"
            placeholder="Enter your age"
            class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200"
            required>
          <p class="text-xs text-text-muted mt-1">
            Must be 13 or older to join BAMACO.
          </p>
        </div>

        <!-- Year Started Playing (Required) -->
        <div>
          <label for="yearStarted" class="block text-sm font-semibold text-text-primary mb-2">
            Year you first played MaiMai <span class="text-red-500">*</span>
          </label>
          <input
            type="number"
            id="yearStarted"
            name="yearStarted"
            min="2012"
            max="2026"
            placeholder="e.g., 2020"
            class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200"
            required>
          <p class="text-xs text-text-muted mt-1">
            What year did you first play MaiMai? (2012-2026)
          </p>
        </div>

        <!-- Motto (Optional) -->
        <div>
          <label for="motto" class="block text-sm font-semibold text-text-primary mb-2">
            Personal Motto (Optional)
          </label>
          <input
            type="text"
            id="motto"
            name="motto"
            placeholder="e.g., 'Rhythm is life!' or 'Always improving!'"
            maxlength="100"
            class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200">
          <p class="text-xs text-text-muted mt-1">
            A short motto or quote that represents you (max 100 characters).
          </p>
        </div>

        <!-- Bio (Optional) -->
        <div>
          <label for="bio" class="block text-sm font-semibold text-text-primary mb-2">
            Bio (Optional)
          </label>
          <textarea
            id="bio"
            name="bio"
            rows="4"
            placeholder="Tell us about yourself, your MaiMai journey, favorite songs, achievements, or anything you'd like to share with the community!"
            maxlength="500"
            class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200 resize-none"></textarea>
          <p class="text-xs text-text-muted mt-1">
            Share your story! Favorite songs, achievements, goals, or anything about your MaiMai experience (max 500 characters).
          </p>
          <div class="text-xs text-text-muted mt-1">
            <span id="bioCount">0</span>/500 characters
          </div>
        </div>

        <!-- Password Section -->
        <div class="border-t border-border-primary pt-6 mt-6">
          <h3 class="text-lg font-semibold text-text-primary mb-4">üîê Account Security</h3>

          <div class="space-y-4">
            <div>
              <label for="password" class="block text-sm font-semibold text-text-primary mb-2">
                Password <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <input
                  type="password"
                  id="password"
                  name="password"
                  placeholder="Create a strong password"
                  class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200 pr-12"
                  required>
                <button type="button" id="togglePassword" class="absolute right-3 top-1/2 -translate-y-1/2 text-text-muted hover:text-text-primary transition-colors">
                  <svg id="eyeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                  </svg>
                </button>
              </div>

              <!-- Password Strength Indicator -->
              <div id="passwordStrength" class="mt-2 space-y-2">
                <div class="flex gap-1">
                  <div class="h-1 flex-1 rounded bg-bg-tertiary" id="strength1"></div>
                  <div class="h-1 flex-1 rounded bg-bg-tertiary" id="strength2"></div>
                  <div class="h-1 flex-1 rounded bg-bg-tertiary" id="strength3"></div>
                  <div class="h-1 flex-1 rounded bg-bg-tertiary" id="strength4"></div>
                </div>
                <p id="strengthText" class="text-xs text-text-muted">Enter a password</p>
              </div>

              <!-- Password Requirements -->
              <div class="mt-3 text-xs text-text-muted space-y-1" id="passwordReqs">
                <div id="reqLength" class="flex items-center gap-2"><span class="text-text-muted">‚óã</span> At least 8 characters</div>
                <div id="reqUpper" class="flex items-center gap-2"><span class="text-text-muted">‚óã</span> One uppercase letter</div>
                <div id="reqNumber" class="flex items-center gap-2"><span class="text-text-muted">‚óã</span> One number</div>
                <div id="reqSpecial" class="flex items-center gap-2"><span class="text-text-muted">‚óã</span> One special character (!@#$%^&*)</div>
              </div>
            </div>

            <div>
              <label for="confirmPassword" class="block text-sm font-semibold text-text-primary mb-2">
                Confirm Password <span class="text-red-500">*</span>
              </label>
              <input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                placeholder="Confirm your password"
                class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200"
                required>
              <div id="passwordMatch" class="mt-2 text-xs hidden"></div>
            </div>
          </div>

          <p class="text-xs text-text-muted mt-3">
            Your password allows you to log in and edit your profile later.
          </p>
        </div>

        <!-- Admin Section (Hidden by default) -->
        <div id="adminSection" class="hidden bg-accent-blue/10 border border-accent-blue/30 rounded-lg p-4">
          <h3 class="font-semibold text-text-primary mb-3">üëë Admin Privileges</h3>
          <div class="space-y-3">
            <div>
              <label class="flex items-center space-x-3">
                <input type="checkbox" id="isAdmin" name="isAdmin" class="w-4 h-4 text-accent-pink">
                <span class="text-sm text-text-primary">Grant admin privileges</span>
              </label>
            </div>
            <div id="adminRoleSection" class="hidden">
              <label for="adminRole" class="block text-sm font-semibold text-text-primary mb-2">
                Admin Role
              </label>
              <select
                id="adminRole"
                name="adminRole"
                class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200">
                <option value="admin">Admin ‚≠ê</option>
                <option value="moderator">Moderator üõ°Ô∏è</option>
                <option value="owner">Owner üëë</option>
              </select>
            </div>
            <div>
              <label for="adminPassword" class="block text-sm font-semibold text-text-primary mb-2">
                Admin Access Code
              </label>
              <input
                type="password"
                id="adminPassword"
                name="adminPassword"
                placeholder="Enter admin access code"
                class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200">
              <p class="text-xs text-text-muted mt-1">
                Contact existing admins for the access code
              </p>
            </div>
          </div>
        </div>

        <!-- Privacy Notice -->
        <div class="bg-accent-yellow/10 border border-accent-yellow/30 rounded-lg p-4">
          <h3 class="font-semibold text-text-primary mb-2">üîí Privacy Notice</h3>
          <p class="text-sm text-text-muted">
            ‚Ä¢ Your profile will be public on the BAMACO website<br>
            ‚Ä¢ Real name is optional and can be kept private<br>
            ‚Ä¢ MaiMai game data (IGN, rating) is retrieved automatically<br>
            ‚Ä¢ You can request updates or removal anytime by contacting admins
          </p>
        </div>

        <!-- Submit Button -->
        <div class="flex flex-col sm:flex-row gap-4 pt-4">
          <button
            type="submit"
            id="submitBtn"
            disabled
            class="flex-1 px-6 py-4 bg-accent-pink text-white font-semibold rounded-lg hover-btn-primary disabled:bg-text-muted disabled:cursor-not-allowed disabled:hover:scale-100 flex items-center justify-center gap-2">
            <span id="submitText">Validate Friend Code First</span>
            <svg id="submitSpinner" class="animate-spin h-5 w-5 hidden" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>

          <a href="players.html" class="px-6 py-4 bg-bg-secondary border border-border-primary text-text-primary font-semibold rounded-lg transition-all duration-300 hover-btn-secondary text-center">
            Cancel
          </a>
        </div>

      </form>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
      <div class="bg-bg-card border border-border-primary rounded-xl p-8 max-w-md w-full text-center">
        <div class="text-6xl mb-4">üéâ</div>
        <h2 class="text-2xl font-bold mb-4">Profile Created!</h2>
        <p class="text-text-muted mb-4">
          Your player profile has been created successfully and is now live on the BAMACO website!
        </p>
        <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4 mb-6 text-left">
          <p class="text-sm font-semibold text-green-500 mb-2">‚úÖ What's next?</p>
          <ul class="text-sm text-text-muted list-disc list-inside space-y-1">
            <li>Your profile is now visible on the Players page</li>
            <li>You can edit your profile anytime by logging in</li>
            <li>Your rating will update automatically from MaiMai</li>
          </ul>
        </div>
        <div class="flex gap-4">
          <a href="#" id="viewProfileBtn" class="flex-1 px-4 py-3 bg-accent-pink text-white rounded-lg font-semibold hover:bg-accent-pink/90 transition-all duration-200">
            View My Profile
          </a>
          <a href="players.html" class="flex-1 px-4 py-3 bg-bg-secondary border border-border-primary rounded-lg font-semibold hover-btn-secondary transition-all duration-200">
            Browse Players
          </a>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
      <div class="bg-bg-card border border-border-primary rounded-xl p-8 max-w-md w-full text-center">
        <div class="text-6xl mb-4">üòï</div>
        <h2 class="text-2xl font-bold mb-4">Profile Creation Failed</h2>
        <p class="text-text-muted mb-4" id="errorMessage">
          An error occurred while creating your profile. Please try again.
        </p>
        <button onclick="document.getElementById('errorModal').classList.add('hidden')"
                class="px-6 py-3 bg-accent-pink text-white rounded-lg font-semibold hover:bg-accent-pink/90 transition-all duration-200">
          Try Again
        </button>
      </div>
    </div>
  </div>

  <footer class="border-t border-border-primary py-6 mt-12 bg-bg-secondary">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 text-center">
      <p class="text-text-muted">&copy; 2026 BAMACO - Bataan MaiMai Community. All rights reserved.</p>
    </div>
  </footer>

  <script src="assets/page-transitions.js"></script>
  <script src="assets/navbar.js"></script>

  <script type="module">
    import { playersDB } from './assets/players-db.js';

    // Global error handlers to prevent unhandled rejections
    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      // Prevent the error from crashing the app
      event.preventDefault();
    });

    // Fallback for crypto API unavailability
    function generateSimpleHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
      }
      return Math.abs(hash).toString(16).padStart(8, '0').substring(0, 16);
    }

    class ProfileCreator {
      constructor() {
        this.isValidatingCode = false;
        this.validFriendCode = false;
        this.passwordValid = false;
        this.passwordMatch = false;
        this.apiData = null;

        this.initializeForm();
      }

      initializeForm() {
        const friendCodeInput = document.getElementById('friendCode');
        const bioTextarea = document.getElementById('bio');
        const form = document.getElementById('profileForm');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const togglePasswordBtn = document.getElementById('togglePassword');

        // Friend code validation
        friendCodeInput.addEventListener('input', (e) => {
          this.formatFriendCode(e.target);
          this.debouncedValidate();
        });

        // Bio character counter
        bioTextarea.addEventListener('input', (e) => {
          const count = e.target.value.length;
          document.getElementById('bioCount').textContent = count;
        });

        // Password validation
        passwordInput.addEventListener('input', () => this.validatePassword());
        confirmPasswordInput.addEventListener('input', () => this.checkPasswordMatch());

        // Toggle password visibility
        togglePasswordBtn.addEventListener('click', () => this.togglePasswordVisibility());

        // Form submission
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          this.submitProfile();
        });

        // Set current year as max for yearStarted
        const currentYear = new Date().getFullYear();
        document.getElementById('yearStarted').max = currentYear;

        // Admin section handling
        const isAdminCheckbox = document.getElementById('isAdmin');
        const adminRoleSection = document.getElementById('adminRoleSection');
        const adminSection = document.getElementById('adminSection');

        // Secret key combination to show admin section
        let keySequence = [];
        document.addEventListener('keydown', (e) => {
          keySequence.push(e.key);
          if (keySequence.length > 5) keySequence.shift();

          // Secret sequence: ADMIN (a-d-m-i-n)
          if (keySequence.join('').toLowerCase().includes('admin')) {
            adminSection.classList.remove('hidden');
            keySequence = []; // Reset sequence
          }
        });

        isAdminCheckbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            adminRoleSection.classList.remove('hidden');
          } else {
            adminRoleSection.classList.add('hidden');
          }
        });
      }

      togglePasswordVisibility() {
        const passwordInput = document.getElementById('password');
        const eyeIcon = document.getElementById('eyeIcon');

        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          eyeIcon.innerHTML = `
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
          `;
        } else {
          passwordInput.type = 'password';
          eyeIcon.innerHTML = `
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          `;
        }
      }

      validatePassword() {
        const password = document.getElementById('password').value;
        const requirements = {
          length: password.length >= 8,
          upper: /[A-Z]/.test(password),
          number: /[0-9]/.test(password),
          special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };

        // Update requirement indicators
        this.updateRequirement('reqLength', requirements.length);
        this.updateRequirement('reqUpper', requirements.upper);
        this.updateRequirement('reqNumber', requirements.number);
        this.updateRequirement('reqSpecial', requirements.special);

        // Calculate strength
        const strength = Object.values(requirements).filter(Boolean).length;
        this.updateStrengthBar(strength);

        // Check if passwords match too
        this.checkPasswordMatch();

        // Update submit button
        this.passwordValid = strength === 4;
        this.updateSubmitButtonState();

        return this.passwordValid;
      }

      updateRequirement(id, met) {
        const el = document.getElementById(id);
        const text = el.textContent.replace(/^[‚úì‚óã]\s*/, '');
        if (met) {
          el.innerHTML = `<span class="text-green-500">‚úì</span> ${text}`;
          el.classList.add('text-green-600');
          el.classList.remove('text-text-muted');
        } else {
          el.innerHTML = `<span class="text-text-muted">‚óã</span> ${text}`;
          el.classList.remove('text-green-600');
          el.classList.add('text-text-muted');
        }
      }

      updateStrengthBar(strength) {
        const colors = ['', 'bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500'];
        const texts = ['Enter a password', 'Weak', 'Fair', 'Good', 'Strong'];

        for (let i = 1; i <= 4; i++) {
          const bar = document.getElementById(`strength${i}`);
          bar.className = `h-1 flex-1 rounded ${i <= strength ? colors[strength] : 'bg-bg-tertiary'}`;
        }

        const strengthText = document.getElementById('strengthText');
        strengthText.textContent = texts[strength];
        strengthText.className = `text-xs ${strength >= 4 ? 'text-green-500' : strength >= 2 ? 'text-yellow-500' : 'text-red-500'}`;
      }

      checkPasswordMatch() {
        const password = document.getElementById('password').value;
        const confirm = document.getElementById('confirmPassword').value;
        const matchDiv = document.getElementById('passwordMatch');

        if (confirm.length === 0) {
          matchDiv.classList.add('hidden');
          this.passwordMatch = false;
        } else if (password === confirm) {
          matchDiv.textContent = '‚úì Passwords match';
          matchDiv.className = 'mt-2 text-xs text-green-600';
          matchDiv.classList.remove('hidden');
          this.passwordMatch = true;
        } else {
          matchDiv.textContent = '‚úó Passwords do not match';
          matchDiv.className = 'mt-2 text-xs text-red-500';
          matchDiv.classList.remove('hidden');
          this.passwordMatch = false;
        }

        this.updateSubmitButtonState();
      }

      updateSubmitButtonState() {
        const btn = document.getElementById('submitBtn');
        const text = document.getElementById('submitText');

        const canSubmit = this.validFriendCode && this.passwordValid && this.passwordMatch;
        btn.disabled = !canSubmit;

        if (!this.validFriendCode) {
          text.textContent = 'Validate Friend Code First';
        } else if (!this.passwordValid) {
          text.textContent = 'Complete Password Requirements';
        } else if (!this.passwordMatch) {
          text.textContent = 'Passwords Must Match';
        } else {
          text.textContent = 'üöÄ Create My Profile';
        }
      }

      formatFriendCode(input) {
        // Keep only digits; length is validated by MaiMai API
        let value = input.value.replace(/\D/g, '');
        input.value = value;
      }

      debouncedValidate() {
        clearTimeout(this.validateTimeout);
        this.validateTimeout = setTimeout(() => {
          this.validateFriendCode();
        }, 1000);
      }

      async validateFriendCode() {
        const input = document.getElementById('friendCode');
        const cleanCode = input.value.replace(/\D/g, '');

        if (this.isValidatingCode) return;
        this.isValidatingCode = true;

        this.showCodeStatus('loading');
        this.updateSubmitButton(false);

        try {
          // Check if profile already exists in Firebase
          const existingPlayer = await playersDB.getPlayer(cleanCode);
          if (existingPlayer) {
            this.showCodeStatus('invalid');
            document.getElementById('friendCodeInvalid').textContent = '‚ö†Ô∏è Profile already exists for this friend code';
            this.updateSubmitButton(false);
            this.validFriendCode = false;
            this.isValidatingCode = false;
            return;
          }

          // Validate using MaiMai API endpoint
          const response = await fetch(`https://maimai-data-get.onrender.com/api/player/${cleanCode}`);
          const data = await response.json();

          if (data.success) {
            this.apiData = data;
            this.showCodeStatus('valid');
            this.showApiData(data);
            this.updateSubmitButton(true);
            this.validFriendCode = true;
          } else {
            document.getElementById('friendCodeInvalid').textContent = '‚ùå Invalid friend code or player not found';
            this.showCodeStatus('invalid');
            this.updateSubmitButton(false);
            this.validFriendCode = false;
          }
        } catch (error) {
          console.error('Validation error:', error);
          document.getElementById('friendCodeInvalid').textContent = '‚ùå API error - please try again';
          this.showCodeStatus('invalid');
          this.updateSubmitButton(false);
          this.validFriendCode = false;
        } finally {
          this.isValidatingCode = false;
        }
      }

      showCodeStatus(status) {
        const statusDiv = document.getElementById('friendCodeStatus');
        const loading = document.getElementById('friendCodeLoading');
        const valid = document.getElementById('friendCodeValid');
        const invalid = document.getElementById('friendCodeInvalid');

        statusDiv.classList.toggle('hidden', status === 'hide');
        loading.classList.toggle('hidden', status !== 'loading');
        valid.classList.toggle('hidden', status !== 'valid');
        invalid.classList.toggle('hidden', status !== 'invalid');
      }

      showApiData(data) {
        const display = document.getElementById('apiDataDisplay');

        document.getElementById('apiIgn').textContent = data.ign || 'Unknown';
        document.getElementById('apiRating').textContent = data.rating || 'Unrated';
        document.getElementById('apiTitle').textContent = data.title || 'None';
        document.getElementById('apiTrophy').textContent = data.trophy || 'None';

        display.classList.remove('hidden');
      }

      updateSubmitButton(enabled) {
        this.validFriendCode = enabled;
        this.updateSubmitButtonState();
      }

      async submitProfile() {
        if (!this.validFriendCode) {
          alert('Please validate your friend code first.');
          return;
        }

        if (!this.passwordValid || !this.passwordMatch) {
          alert('Please complete password requirements.');
          return;
        }

        const btn = document.getElementById('submitBtn');
        const text = document.getElementById('submitText');
        const spinner = document.getElementById('submitSpinner');

        // Show loading state
        btn.disabled = true;
        text.textContent = 'Creating Profile...';
        spinner.classList.remove('hidden');

        try {
          const formData = new FormData(document.getElementById('profileForm'));
          const data = {};

          // Collect form data
          for (let [key, value] of formData.entries()) {
            if (key !== 'confirmPassword') {
              data[key] = value.trim();
            }
          }

          // Set default name if empty
          if (!data.fullName) {
            data.fullName = 'REDACTED';
          }

          // Hash the password
          const passwordHash = await this.hashPassword(data.password);
          delete data.password;

          // Create device fingerprint
          const fingerprint = await this.generateFingerprint();

          // Prepare player data for Firebase
          const friendCode = data.friendCode.replace(/\D/g, '');

          // Check admin settings
          const isAdmin = document.getElementById('isAdmin').checked;
          const adminRole = document.getElementById('adminRole').value;
          const adminPassword = document.getElementById('adminPassword').value;
          const ADMIN_ACCESS_CODE = '104625140040Aa@.'; // Change this for security

          // Validate admin access if admin is checked
          if (isAdmin && adminPassword !== ADMIN_ACCESS_CODE) {
            throw new Error('Invalid admin access code. Please contact existing admins.');
          }

          const playerData = {
            friendCode: friendCode,
            ign: this.apiData.ign,
            name: data.fullName,
            nickname: data.fullName === 'REDACTED' ? this.apiData.ign : data.fullName,
            title: this.apiData.title || this.apiData.trophy || '',
            avatarImage: this.apiData.avatar_url || this.apiData.icon_url || this.apiData.iconUrl || this.apiData.avatarImage || this.apiData.icon || '',
            rating: this.apiData.rating || '0',
            rank: 'Unranked',
            trophy: this.apiData.trophy || '',
            age: data.age,
            motto: data.motto || '',
            joined: data.yearStarted,
            bio: data.bio || '',
            guildId: '',
            achievements: [],
            articles: [],
            passwordHash: passwordHash,
            fingerprint: fingerprint,
            isAdmin: isAdmin,
            adminRole: isAdmin ? adminRole : null,
            isPublic: true
          };

          // Create player in Firebase
          const player = await playersDB.createPlayer(playerData);
          console.log('‚úÖ Player created in Firebase:', player);

          // Store session in localStorage for auto-login
          const session = {
            user: {
              friendCode: friendCode,
              ign: this.apiData.ign,
              isAdmin: isAdmin,
              adminRole: isAdmin ? adminRole : null
            },
            expiresAt: Date.now() + (30 * 24 * 60 * 60 * 1000) // 30 days
          };
          localStorage.setItem('bamaco_session', JSON.stringify(session));
          localStorage.setItem('profileEditKey', player.editKey);

          // Show success modal
          this.showSuccessModal(friendCode);

        } catch (error) {
          console.error('Submit error:', error);
          this.showErrorModal(error.message || 'Failed to create profile. Please try again.');

          // Reset button
          btn.disabled = false;
          text.textContent = 'üöÄ Create My Profile';
          spinner.classList.add('hidden');
        }
      }

      async hashPassword(password) {
        // Generate salt
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const saltHex = Array.from(salt).map(b => b.toString(16).padStart(2, '0')).join('');

        try {
          // Hash password with salt - with fallback
          if (!crypto || !crypto.subtle || !crypto.subtle.digest) {
            // Fallback if crypto API unavailable
            const fingerprint = saltHex + password;
            const hash = generateSimpleHash(fingerprint);
            return `${saltHex}:${hash}`;
          }

          const encoder = new TextEncoder();
          const data = encoder.encode(saltHex + password);
          const hashBuffer = await crypto.subtle.digest('SHA-256', data);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

          return `${saltHex}:${hashHex}`;
        } catch (error) {
          console.error('Crypto error in hashPassword:', error);
          // Fallback to simple hash
          const fingerprint = saltHex + password;
          const hash = generateSimpleHash(fingerprint);
          return `${saltHex}:${hash}`;
        }
      }

      async generateFingerprint() {
        // Create a simple device fingerprint
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('BAMACO Profile Fingerprint', 2, 2);

        return btoa(JSON.stringify({
          screen: `${screen.width}x${screen.height}`,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          language: navigator.language,
          canvas: canvas.toDataURL().substring(0, 50),
          timestamp: Date.now()
        })).substring(0, 32);
      }

      showSuccessModal(friendCode) {
        document.getElementById('viewProfileBtn').href = `player-profile.html?id=${friendCode}`;
        document.getElementById('successModal').classList.remove('hidden');
      }

      showErrorModal(message) {
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorModal').classList.remove('hidden');
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new ProfileCreator();
    });
  </script>
</body>
</html>
