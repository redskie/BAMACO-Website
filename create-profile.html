<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Profile - BAMACO</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="assets/tailwind-config.js"></script>
  <script>tailwind.config = window.BAMACO_TAILWIND_CONFIG;</script>
  <script src="assets/loading-optimizer.js"></script>
  
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body class="bg-bg-primary text-text-primary font-sans antialiased">
  <!-- Navigation -->
  <!-- Navbar will be dynamically generated by navbar.js -->

  <div class="max-w-4xl mx-auto px-4 sm:px-6 py-8 sm:py-12">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl sm:text-4xl lg:text-5xl font-black text-text-primary mb-2">Create Your Profile</h1>
      <p class="text-text-muted text-base sm:text-lg">Join the BAMACO community! Your profile will be created automatically.</p>
    </div>

    <!-- Profile Creation Form -->
    <div class="bg-bg-card border border-border-primary rounded-xl p-6 sm:p-8 mb-8">
      <form id="profileForm" class="space-y-6">
        
        <!-- MaiMai Friend Code (Required) -->
        <div>
          <label for="friendCode" class="block text-sm font-semibold text-text-primary mb-2">
            MaiMai Friend Code <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <input 
              type="text" 
              id="friendCode" 
              name="friendCode"
              placeholder="000000000000000 (15 digits)"
              maxlength="17"
              class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200"
              required>
            <div id="friendCodeStatus" class="mt-2 text-sm hidden">
              <div id="friendCodeLoading" class="flex items-center text-text-muted">
                <svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Validating friend code...
              </div>
              <div id="friendCodeValid" class="text-green-600 hidden">‚úÖ Valid friend code!</div>
              <div id="friendCodeInvalid" class="text-red-500 hidden">‚ùå Invalid friend code or player not found</div>
            </div>
          </div>
          <p class="text-xs text-text-muted mt-1">
            Your 15-digit MaiMai friend code. We'll automatically get your IGN, rating, and avatar from the game.
          </p>
        </div>

        <!-- API Retrieved Data Display -->
        <div id="apiDataDisplay" class="hidden bg-bg-tertiary border border-border-primary rounded-lg p-4">
          <h3 class="font-semibold text-text-primary mb-3">üì° Retrieved from MaiMai API:</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
            <div><strong>IGN:</strong> <span id="apiIgn">-</span></div>
            <div><strong>Rating:</strong> <span id="apiRating">-</span></div>
            <div><strong>Title:</strong> <span id="apiTitle">-</span></div>
            <div><strong>Trophy:</strong> <span id="apiTrophy">-</span></div>
          </div>
        </div>

        <!-- Name (Optional) -->
        <div>
          <label for="fullName" class="block text-sm font-semibold text-text-primary mb-2">
            Real Name (Optional)
          </label>
          <input 
            type="text" 
            id="fullName" 
            name="fullName"
            placeholder="Leave blank for privacy (will show as REDACTED)"
            class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200">
          <p class="text-xs text-text-muted mt-1">
            Your real name. Leave blank if you prefer privacy - it will show as "REDACTED".
          </p>
        </div>

        <!-- Age (Required) -->
        <div>
          <label for="age" class="block text-sm font-semibold text-text-primary mb-2">
            Age <span class="text-red-500">*</span>
          </label>
          <input 
            type="number" 
            id="age" 
            name="age"
            min="13" 
            max="100"
            placeholder="Enter your age"
            class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200"
            required>
          <p class="text-xs text-text-muted mt-1">
            Must be 13 or older to join BAMACO.
          </p>
        </div>

        <!-- Year Started Playing (Required) -->
        <div>
          <label for="yearStarted" class="block text-sm font-semibold text-text-primary mb-2">
            Year you first played MaiMai <span class="text-red-500">*</span>
          </label>
          <input 
            type="number" 
            id="yearStarted" 
            name="yearStarted"
            min="2012" 
            max="2026"
            placeholder="e.g., 2020"
            class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200"
            required>
          <p class="text-xs text-text-muted mt-1">
            What year did you first play MaiMai? (2012-2026)
          </p>
        </div>

        <!-- Motto (Optional) -->
        <div>
          <label for="motto" class="block text-sm font-semibold text-text-primary mb-2">
            Personal Motto (Optional)
          </label>
          <input 
            type="text" 
            id="motto" 
            name="motto"
            placeholder="e.g., 'Rhythm is life!' or 'Always improving!'"
            maxlength="100"
            class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200">
          <p class="text-xs text-text-muted mt-1">
            A short motto or quote that represents you (max 100 characters).
          </p>
        </div>

        <!-- Bio (Optional) -->
        <div>
          <label for="bio" class="block text-sm font-semibold text-text-primary mb-2">
            Bio (Optional)
          </label>
          <textarea 
            id="bio" 
            name="bio"
            rows="4"
            placeholder="Tell us about yourself, your MaiMai journey, favorite songs, achievements, or anything you'd like to share with the community!"
            maxlength="500"
            class="w-full px-4 py-3 border border-border-primary rounded-lg bg-bg-secondary focus:outline-none focus:ring-2 focus:ring-accent-pink focus:border-accent-pink transition-all duration-200 resize-none"></textarea>
          <p class="text-xs text-text-muted mt-1">
            Share your story! Favorite songs, achievements, goals, or anything about your MaiMai experience (max 500 characters).
          </p>
          <div class="text-xs text-text-muted mt-1">
            <span id="bioCount">0</span>/500 characters
          </div>
        </div>

        <!-- Privacy Notice -->
        <div class="bg-accent-yellow/10 border border-accent-yellow/30 rounded-lg p-4">
          <h3 class="font-semibold text-text-primary mb-2">üîí Privacy Notice</h3>
          <p class="text-sm text-text-muted">
            ‚Ä¢ Your profile will be public on the BAMACO website<br>
            ‚Ä¢ Real name is optional and can be kept private<br>
            ‚Ä¢ MaiMai game data (IGN, rating) is retrieved automatically<br>
            ‚Ä¢ You can request updates or removal anytime by contacting admins
          </p>
        </div>

        <!-- Submit Button -->
        <div class="flex flex-col sm:flex-row gap-4 pt-4">
          <button 
            type="submit" 
            id="submitBtn"
            disabled
            class="flex-1 px-6 py-4 bg-accent-pink text-white font-semibold rounded-lg hover-btn-primary disabled:bg-text-muted disabled:cursor-not-allowed disabled:hover:scale-100 flex items-center justify-center gap-2">
            <span id="submitText">Validate Friend Code First</span>
            <svg id="submitSpinner" class="animate-spin h-5 w-5 hidden" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
          
          <a href="players.html" class="px-6 py-4 bg-bg-secondary border border-border-primary text-text-primary font-semibold rounded-lg transition-all duration-300 hover-btn-secondary text-center">
            Cancel
          </a>
        </div>

      </form>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
      <div class="bg-bg-card border border-border-primary rounded-xl p-8 max-w-md w-full text-center">
        <div class="text-6xl mb-4">üéâ</div>
        <h2 class="text-2xl font-bold mb-4">Profile Created!</h2>
        <p class="text-text-muted mb-6">
          Your profile request has been submitted successfully! 
          It will be processed automatically and live on the website within a few minutes.
        </p>
        <div class="flex gap-4">
          <a href="players.html" class="flex-1 px-4 py-3 bg-accent-pink text-white rounded-lg font-semibold hover:bg-accent-pink/90 transition-all duration-200">
            View Players
          </a>
          <a href="index.html" class="flex-1 px-4 py-3 bg-bg-secondary border border-border-primary rounded-lg font-semibold hover-btn-secondary transition-all duration-200">
            Home
          </a>
        </div>
      </div>
    </div>
  </div>

  <footer class="border-t border-border-primary py-8 mt-12 bg-gradient-to-r from-bg-card to-bg-secondary shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 text-center">
      <p class="text-text-muted">&copy; 2026 BAMACO - Bataan MaiMai Community. All rights reserved.</p>
    </div>
  </footer>

  <script src="assets/page-transitions.js"></script>
  <script src="assets/navbar.js"></script>

  <script>
    class ProfileCreator {
      constructor() {
        this.isValidatingCode = false;
        this.validFriendCode = false;
        this.apiData = null;
        
        this.initializeForm();
      }

      initializeForm() {
        const friendCodeInput = document.getElementById('friendCode');
        const bioTextarea = document.getElementById('bio');
        const form = document.getElementById('profileForm');
        
        // Friend code validation
        friendCodeInput.addEventListener('input', (e) => {
          this.formatFriendCode(e.target);
          this.debouncedValidate();
        });
        
        // Bio character counter
        bioTextarea.addEventListener('input', (e) => {
          const count = e.target.value.length;
          document.getElementById('bioCount').textContent = count;
        });
        
        // Form submission
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          this.submitProfile();
        });
        
        // Set current year as max for yearStarted
        const currentYear = new Date().getFullYear();
        document.getElementById('yearStarted').max = currentYear;
      }

      formatFriendCode(input) {
        // Remove non-digits
        let value = input.value.replace(/\D/g, '');
        
        // Limit to 15 digits
        if (value.length > 15) {
          value = value.substring(0, 15);
        }
        
        // Format with dashes for readability (but store without)
        if (value.length > 0) {
          const formatted = value.match(/.{1,3}/g).join('-');
          input.value = formatted;
        }
      }

      debouncedValidate() {
        clearTimeout(this.validateTimeout);
        this.validateTimeout = setTimeout(() => {
          this.validateFriendCode();
        }, 1000);
      }

      async validateFriendCode() {
        const input = document.getElementById('friendCode');
        const cleanCode = input.value.replace(/\D/g, '');
        
        if (cleanCode.length !== 15) {
          this.showCodeStatus('hide');
          this.updateSubmitButton(false);
          return;
        }

        if (this.isValidatingCode) return;
        this.isValidatingCode = true;

        this.showCodeStatus('loading');
        this.updateSubmitButton(false);

        try {
          // Validate using MaiMai API endpoint
          const response = await fetch(`https://maimai-data-get.onrender.com/api/player/${cleanCode}`);
          const data = await response.json();

          if (data.success) {
            this.apiData = data;
            this.showCodeStatus('valid');
            this.showApiData(data);
            this.updateSubmitButton(true);
            this.validFriendCode = true;
          } else {
            this.showCodeStatus('invalid');
            this.updateSubmitButton(false);
            this.validFriendCode = false;
          }
        } catch (error) {
          console.error('Validation error:', error);
          this.showCodeStatus('invalid');
          this.updateSubmitButton(false);
          this.validFriendCode = false;
        } finally {
          this.isValidatingCode = false;
        }
      }

      showCodeStatus(status) {
        const statusDiv = document.getElementById('friendCodeStatus');
        const loading = document.getElementById('friendCodeLoading');
        const valid = document.getElementById('friendCodeValid');
        const invalid = document.getElementById('friendCodeInvalid');

        statusDiv.classList.toggle('hidden', status === 'hide');
        loading.classList.toggle('hidden', status !== 'loading');
        valid.classList.toggle('hidden', status !== 'valid');
        invalid.classList.toggle('hidden', status !== 'invalid');
      }

      showApiData(data) {
        const display = document.getElementById('apiDataDisplay');
        
        document.getElementById('apiIgn').textContent = data.ign || 'Unknown';
        document.getElementById('apiRating').textContent = data.rating || 'Unrated';
        document.getElementById('apiTitle').textContent = data.title || 'None';
        document.getElementById('apiTrophy').textContent = data.trophy || 'None';
        
        display.classList.remove('hidden');
      }

      updateSubmitButton(enabled) {
        const btn = document.getElementById('submitBtn');
        const text = document.getElementById('submitText');
        
        btn.disabled = !enabled;
        text.textContent = enabled ? 'üöÄ Create My Profile' : 'Validate Friend Code First';
      }

      async submitProfile() {
        if (!this.validFriendCode) {
          alert('Please validate your friend code first.');
          return;
        }

        const btn = document.getElementById('submitBtn');
        const text = document.getElementById('submitText');
        const spinner = document.getElementById('submitSpinner');
        
        // Show loading state
        btn.disabled = true;
        text.textContent = 'Creating Profile...';
        spinner.classList.remove('hidden');

        try {
          const formData = new FormData(document.getElementById('profileForm'));
          const data = {};
          
          // Collect form data
          for (let [key, value] of formData.entries()) {
            data[key] = value.trim();
          }
          
          // Set default name if empty
          if (!data.fullName) {
            data.fullName = 'REDACTED';
          }
          
          // Generate unique edit key
          data.editKey = this.generateEditKey();
          
          // Create device fingerprint for security
          data.fingerprint = await this.generateFingerprint();
          
          // Create GitHub issue
          await this.createGitHubIssue(data);
          
        } catch (error) {
          console.error('Submit error:', error);
          alert('Failed to create profile. Please try again.');
          
          // Reset button
          btn.disabled = false;
          text.textContent = 'üöÄ Create My Profile';
          spinner.classList.add('hidden');
        }
      }

      generateEditKey() {
        return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
      }

      async generateFingerprint() {
        // Create a simple device fingerprint
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('BAMACO Profile Fingerprint', 2, 2);
        
        return btoa(JSON.stringify({
          screen: `${screen.width}x${screen.height}`,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          language: navigator.language,
          canvas: canvas.toDataURL().substring(0, 50),
          timestamp: Date.now()
        }));
      }

      async createGitHubIssue(data) {
        // Format profile data for GitHub issue
        const profileData = `
**Edit Key:** \`${data.editKey}\`
**Device Fingerprint:** \`${data.fingerprint}\`
**IGN:** ${this.apiData.ign}
**Full Name:** ${data.fullName}
**Nickname:** ${data.fullName === 'REDACTED' ? this.apiData.ign : data.fullName}
**Age:** ${data.age}
**Friend Code:** ${data.friendCode.replace(/\D/g, '')}
**Motto:** ${data.motto || 'None'}
**Year Started:** ${data.yearStarted}
**Bio:** ${data.bio || 'None'}

---

**API Retrieved Data:**
- Rating: ${this.apiData.rating}
- Title: ${this.apiData.title || 'None'}
- Trophy: ${this.apiData.trophy || 'None'}
- Icon URL: ${this.apiData.icon_url || 'None'}
        `.trim();

        // Create GitHub issue via API
        const response = await fetch('https://api.github.com/repos/redskie/BAMACO-Website/issues', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            title: `[PROFILE-NEW] ${this.apiData.ign}`,
            body: profileData,
            labels: ['player-profile-request']
          })
        });

        if (response.ok) {
          this.showSuccessModal();
        } else {
          throw new Error('GitHub API request failed');
        }
      }

      showSuccessModal() {
        document.getElementById('successModal').classList.remove('hidden');
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new ProfileCreator();
    });
  </script>
</body>
</html>
